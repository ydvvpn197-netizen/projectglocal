<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Relaxed but safe CSP for Vite + Supabase in development -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://theglocal.in https://*.theglocal.in http://localhost:* http://127.0.0.1:*; worker-src 'self' blob:;">
    
    <!-- GitHub Pages SPA Routing -->
    <script type="text/javascript">
      // Single Page Apps for GitHub Pages
      // MIT License
      // https://github.com/rafgraph/spa-github-pages
      // This script checks to see if a redirect is present in the query string,
      // converts it back into the correct url and adds it to the
      // browser's history using window.history.replaceState(...),
      // which won't cause the browser to attempt to load the new url.
      // When the single page app is loaded further down in this file,
      // the correct url will be waiting in the browser's history for
      // the single page app to route accordingly.
      (function(l) {
        if (l.search[1] === '/' ) {
          var decoded = l.search.slice(1).split('&').map(function(s) { 
            return s.replace(/~and~/g, '&')
          }).join('?');
          window.history.replaceState(null, null,
              l.pathname.slice(0, -1) + decoded + l.hash
          );
        }
      }(window.location))
    </script>
    
    <title>The Glocal — Local Social Hub</title>
    <meta name="description" content="Discover local events, connect with your community, and book talented artists near you." />
    <link rel="canonical" href="https://theglocal.in/" />

    <!-- Performance: Preconnect to Supabase -->
    <link rel="preconnect" href="https://tepvzhbgobckybyhryuj.supabase.co" crossorigin />
    <meta name="theme-color" content="#6D28D9" />

    <!-- Open Graph -->
    <meta property="og:title" content="The Glocal — Local Social Hub" />
    <meta property="og:description" content="Discover local events, connect with your community, and book talented artists near you." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root">
      <!-- Fallback content (replaced once JS loads) -->
      <noscript>
        <style>body{background:#fff;color:#111;font-family:system-ui,sans-serif}</style>
        <div style="max-width:680px;margin:40px auto;padding:16px">
          <h1>The Glocal</h1>
          <p>JavaScript is required to run this app. Please enable JavaScript and reload.</p>
        </div>
      </noscript>
    </div>
    
    <!-- Enhanced error handling for React initialization issues -->
    <script type="text/javascript">
      // Track script loading errors
      let scriptLoadErrors = 0;
      let maxRetries = 3;
      
      window.addEventListener('error', function(e) {
        console.warn('Script error detected:', e.message);
        
        // Check for React initialization issues
        if (e.message && (e.message.includes('Cannot access') || e.message.includes('React') || e.message.includes('ot'))) {
          scriptLoadErrors++;
          console.warn('Detected React initialization issue, attempting recovery... (attempt ' + scriptLoadErrors + '/' + maxRetries + ')');
          
          if (scriptLoadErrors <= maxRetries) {
            // Try to reload the page after a short delay
            setTimeout(function() {
              console.log('Reloading page to fix React initialization issue...');
              window.location.reload();
            }, 2000);
          } else {
            console.error('Max retries reached for React initialization issues');
            // Show error message to user
            const rootElement = document.getElementById("root");
            if (rootElement) {
              rootElement.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui, sans-serif;">
                  <div style="text-align: center; padding: 2rem;">
                    <h1>The Glocal</h1>
                    <p style="color: #e53e3e;">Application failed to load properly.</p>
                    <p style="color: #666; font-size: 0.9rem;">Please try refreshing the page or clearing your browser cache.</p>
                    <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #6D28D9; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      Refresh Page
                    </button>
                  </div>
                </div>
              `;
            }
          }
        }
      });
      
      // Add unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(e) {
        console.warn('Unhandled promise rejection:', e.reason);
        if (e.reason && e.reason.message && e.reason.message.includes('React')) {
          console.warn('React-related promise rejection detected');
        }
      });
    </script>
    
    <!-- Load main application script -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
