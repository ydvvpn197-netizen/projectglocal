var h=Object.defineProperty,v=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var w=(n,o,a)=>o in n?h(n,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[o]=a,s=(n,o)=>{for(var a in o||(o={}))y.call(o,a)&&w(n,a,o[a]);if(E)for(var a of E(o))S.call(o,a)&&w(n,a,o[a]);return n},c=(n,o)=>v(n,m(o));var L=(n,o,a)=>new Promise((i,l)=>{var b=t=>{try{d(a.next(t))}catch(e){l(e)}},p=t=>{try{d(a.throw(t))}catch(e){l(e)}},d=t=>t.done?i(t.value):Promise.resolve(t.value).then(b,p);d((a=a.apply(n,o)).next())});import{u as C,g as U,r as u}from"./main-jfCIwKxb.js";import{L as f}from"./locationService-D_4XBFWa.js";const A=()=>{const{user:n}=C(),{toast:o}=U(),[a,i]=u.useState({currentLocation:null,isEnabled:!1,isLoading:!1,error:null,lastUpdated:null});u.useEffect(()=>{L(void 0,null,function*(){if(n)try{const e=yield f.getCurrentUserLocation(),r=yield f.getLocationSettings();i(e?g=>c(s({},g),{isEnabled:r.enabled,currentLocation:{latitude:e.lat,longitude:e.lng},lastUpdated:new Date}):g=>c(s({},g),{isEnabled:r.enabled,currentLocation:null}))}catch(e){console.error("Error loading location preferences:",e)}})},[n]);const l=u.useCallback(()=>new Promise((t,e)=>{if(!navigator.geolocation){e(new Error("Geolocation is not supported by this browser"));return}navigator.geolocation.getCurrentPosition(r=>{t({latitude:r.coords.latitude,longitude:r.coords.longitude,accuracy:r.coords.accuracy})},r=>{e(new Error(`Location error: ${r.message}`))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}),[]),b=u.useCallback(t=>L(void 0,null,function*(){if(n)try{const e={lat:t.latitude,lng:t.longitude};yield f.setManualLocation(e)}catch(e){throw console.error("Error updating location in database:",e),e}}),[n]),p=u.useCallback(()=>L(void 0,null,function*(){if(n){i(t=>c(s({},t),{isLoading:!0,error:null}));try{if(!a.isEnabled){const e=yield l(),r={lat:e.latitude,lng:e.longitude};yield f.detectAndSaveLocation(),i(g=>c(s({},g),{isEnabled:!0,currentLocation:e,lastUpdated:new Date,isLoading:!1})),o({title:"Location sharing enabled",description:"Your location will be used to show relevant local content."})}else yield f.toggleLocationServices(!1),i(e=>c(s({},e),{isEnabled:!1,currentLocation:null,lastUpdated:null,isLoading:!1})),o({title:"Location sharing disabled",description:"Location data has been cleared."})}catch(t){const e=t instanceof Error?t.message:"Unknown error";i(r=>c(s({},r),{error:e,isLoading:!1})),o({title:"Location error",description:e,variant:"destructive"})}}}),[n,a.isEnabled,l,o]),d=u.useCallback(()=>L(void 0,null,function*(){if(!(!n||!a.isEnabled)){i(t=>c(s({},t),{isLoading:!0,error:null}));try{const t=yield l();yield b(t),i(e=>c(s({},e),{currentLocation:t,lastUpdated:new Date,isLoading:!1})),o({title:"Location updated",description:"Your current location has been refreshed."})}catch(t){const e=t instanceof Error?t.message:"Location update failed";i(r=>c(s({},r),{error:e,isLoading:!1})),o({title:"Location update failed",description:e,variant:"destructive"})}}}),[n,a.isEnabled,l,b,o]);return u.useEffect(()=>{if(!a.isEnabled)return;const t=setInterval(()=>{d()},15*60*1e3);return()=>clearInterval(t)},[a.isEnabled,d]),c(s({},a),{toggleLocationSharing:p,updateCurrentLocation:d})};export{A as u};
