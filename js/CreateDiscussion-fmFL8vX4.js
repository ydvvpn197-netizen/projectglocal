var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,n=(s,t,i)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i,a=(e,s,t)=>new Promise((i,r)=>{var o=e=>{try{a(t.next(e))}catch(s){r(s)}},n=e=>{try{a(t.throw(e))}catch(s){r(s)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,n);a((t=t.apply(e,s)).next())});import{r as c,u as l,d as u,s as d,b as m,j as p,B as j}from"./index-B5IYdG7F.js";import{C as h,a as x,b as y,c as f,d as g}from"./card-Bm1jiGt-.js";import{I as v}from"./input-C4_QhDnm.js";import{T as b}from"./textarea-DnhiZrYB.js";import{S as N,a as w,b as C,c as S,d as _}from"./select-DME_qdt9.js";import{L as D}from"./label-BIAuZBUP.js";import{C as P}from"./checkbox-Cu_S15Df.js";import{R as E}from"./ResponsiveLayout-BzUw0buI.js";import{u as A}from"./useLocation-BN9qq_uk.js";import{A as O}from"./arrow-left-CfH2SqfZ.js";import{M as I}from"./message-circle-CZlRU4gv.js";import"./index-jVOyRz7F.js";import"./index-9msbY5CZ.js";import"./Combination-BxRIZ8rt.js";import"./index-_KG4atBu.js";import"./chevron-up-DvjQ7ry8.js";import"./check-C9wwFfOs.js";import"./separator-BZYZTYLW.js";import"./sheet-CgDUfSpi.js";import"./index-DD_J5sPn.js";import"./NotificationBell-DtnEojo4.js";import"./badge-Dh5Uj8vN.js";import"./scroll-area-Beiyt5Kx.js";import"./useNotifications-C0wifgqF.js";import"./tabs-DPPBWbFC.js";import"./bell-qeMkXRtc.js";import"./settings-DSEWn2wM.js";import"./user-UOowhO7W.js";import"./index-DWtoKlrM.js";import"./NotificationButton-CqXjP_LK.js";import"./search-Co_OHmlK.js";import"./map-pin-BwnggLrZ.js";import"./users-Dh-Bdb-k.js";import"./zap-DPSXpNso.js";import"./message-square-j4RxGxzk.js";import"./alert-CQybxmNr.js";import"./log-out-DchhrZ8K.js";import"./locationService-BBE-Ay-I.js";const k=()=>{const e=m(),{toast:k}=u(),{user:F}=l(),{createDiscussion:q}=(()=>{const[e,s]=c.useState([]),[t,i]=c.useState(!0),{user:r}=l(),{toast:o}=u(),{currentLocation:n}=A(),m=()=>a(void 0,null,function*(){try{i(!0);const{data:e,error:t}=yield d.rpc("get_discussions_with_details");if(t)throw t;s(e||[])}catch(e){o({title:"Error",description:"Failed to fetch discussions",variant:"destructive"})}finally{i(!1)}});return c.useEffect(()=>{r&&m()},[r]),{discussions:e,loading:t,createDiscussion:e=>a(void 0,null,function*(){if(!r)return o({title:"Error",description:"You must be logged in to create discussions",variant:"destructive"}),!1;try{const{error:s}=yield d.from("discussions").insert({user_id:r.id,title:e.title,content:e.content,category:e.category||"general",is_anonymous:e.is_anonymous||!1,group_id:e.group_id||null,latitude:null==n?void 0:n.latitude,longitude:null==n?void 0:n.longitude});if(s)throw s;return o({title:"Success",description:"Discussion created successfully!"}),m(),!0}catch(s){return o({title:"Error",description:"Failed to create discussion",variant:"destructive"}),!1}}),deleteDiscussion:e=>a(void 0,null,function*(){if(!r)return{error:new Error("Not authenticated")};try{const{error:s}=yield d.from("discussions").delete().eq("id",e).eq("user_id",r.id);if(s)throw s;return o({title:"Discussion deleted",description:"Your discussion has been deleted successfully."}),m(),{error:null}}catch(s){return o({title:"Error deleting discussion",description:s.message,variant:"destructive"}),{error:s}}}),refetch:m}})(),[B,L]=c.useState(!1),[R,z]=c.useState([]),[V,G]=c.useState({title:"",content:"",groupId:"",category:"general",isAnonymous:!1});c.useEffect(()=>{(()=>{a(void 0,null,function*(){if(F)try{const{data:e,error:s}=yield d.from("groups").select("\n            id,\n            name,\n            description,\n            category,\n            group_members!inner (role)\n          ").eq("group_members.user_id",F.id);if(s)throw s;z(e||[])}catch(e){}})})()},[F]);const M=(e,a)=>{G(c=>((e,i)=>s(e,t(i)))(((e,s)=>{for(var t in s||(s={}))r.call(s,t)&&n(e,t,s[t]);if(i)for(var t of i(s))o.call(s,t)&&n(e,t,s[t]);return e})({},c),{[e]:a}))};return p.jsx(E,{children:p.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[p.jsx("div",{className:"flex items-center gap-4",children:p.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>e("/community"),className:"flex items-center gap-2",children:[p.jsx(O,{className:"h-4 w-4"}),"Back to Community"]})}),p.jsxs(h,{children:[p.jsxs(x,{children:[p.jsxs("div",{className:"flex items-center gap-2",children:[p.jsx(I,{className:"h-6 w-6 text-primary"}),p.jsx(y,{className:"text-2xl",children:"Start a Discussion"})]}),p.jsx(f,{children:"Share your thoughts and engage with your community"})]}),p.jsx(g,{children:p.jsxs("form",{onSubmit:s=>a(void 0,null,function*(){if(s.preventDefault(),F)if(V.title.trim()&&V.content.trim())if(V.isAnonymous||V.groupId){L(!0);try{(yield q({title:V.title,content:V.content,category:V.category,is_anonymous:V.isAnonymous,group_id:V.isAnonymous?void 0:V.groupId}))&&e("/community")}catch(t){}finally{L(!1)}}else k({title:"Error",description:"Please select a group or choose anonymous discussion.",variant:"destructive"});else k({title:"Error",description:"Please fill in title and content.",variant:"destructive"})}),className:"space-y-6",children:[p.jsxs("div",{className:"space-y-4",children:[p.jsxs("div",{className:"flex items-center space-x-2",children:[p.jsx(P,{id:"anonymous",checked:V.isAnonymous,onCheckedChange:e=>M("isAnonymous",e)}),p.jsx(D,{htmlFor:"anonymous",className:"text-sm font-medium",children:"Post anonymously (without joining a group)"})]}),!V.isAnonymous&&p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"group",children:"Group *"}),p.jsxs(N,{value:V.groupId,onValueChange:e=>M("groupId",e),children:[p.jsx(w,{children:p.jsx(C,{placeholder:"Select a group to post in"})}),p.jsx(S,{children:R.map(e=>p.jsx(_,{value:e.id,children:e.name},e.id))})]})]})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"title",children:"Discussion Title *"}),p.jsx(v,{id:"title",placeholder:"What would you like to discuss?",value:V.title,onChange:e=>M("title",e.target.value),className:"text-lg"})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"content",children:"Description *"}),p.jsx(b,{id:"content",placeholder:"Provide more details about your discussion...",value:V.content,onChange:e=>M("content",e.target.value),rows:6})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"category",children:"Category"}),p.jsxs(N,{value:V.category,onValueChange:e=>M("category",e),children:[p.jsx(w,{children:p.jsx(C,{})}),p.jsxs(S,{children:[p.jsx(_,{value:"general",children:"General"}),p.jsx(_,{value:"question",children:"Question"}),p.jsx(_,{value:"event",children:"Event"}),p.jsx(_,{value:"recommendation",children:"Recommendation"}),p.jsx(_,{value:"announcement",children:"Announcement"})]})]})]}),p.jsxs("div",{className:"flex gap-4 pt-4",children:[p.jsx(j,{type:"button",variant:"outline",onClick:()=>e("/community"),className:"flex-1",children:"Cancel"}),p.jsx(j,{type:"submit",disabled:B||!V.title.trim()||!V.content.trim()||!V.isAnonymous&&!V.groupId,className:"flex-1",children:B?"Creating...":"Start Discussion"})]})]})})]})]})})};export{k as default};
