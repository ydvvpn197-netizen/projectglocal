var W=Object.defineProperty;var G=(y,e,r)=>e in y?W(y,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):y[e]=r;var x=(y,e,r)=>G(y,typeof e!="symbol"?e+"":e,r);var m=(y,e,r)=>new Promise((h,n)=>{var u=c=>{try{d(r.next(c))}catch(A){n(A)}},o=c=>{try{d(r.throw(c))}catch(A){n(A)}},d=c=>c.done?h(c.value):Promise.resolve(c.value).then(u,o);d((r=r.apply(y,e)).next())});import{r as v,j as N}from"./chunk-COTa-BBv.js";import{s as U,r as P,w as _,f as j,g as $}from"./chunk-CasIWBEQ.js";import{u as T,A as z}from"./main-BMj1NFFE.js";import{U as R}from"./chunk-BPfgVWOI.js";import"./chunk-DvlvDbdf.js";import"./chunk-BlluHz2J.js";import"./chunk-DJzzOJWe.js";import"./chunk-BA32w1ww.js";import"./chunk-C4jjqBrH.js";const H=()=>{try{localStorage.removeItem("supabase.auth.token"),localStorage.removeItem("supabase.auth.session"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_session"),sessionStorage.removeItem("supabase.auth.token"),sessionStorage.removeItem("supabase.auth.session"),sessionStorage.removeItem("auth_user"),sessionStorage.removeItem("auth_session"),console.log("Auth data cleared successfully")}catch(y){console.error("Error clearing auth data:",y)}},B=()=>{try{const y=localStorage.getItem("supabase.auth.token");if(!y)return!1;const r=JSON.parse(y).expires_at;return r?Date.now()/1e3>r:!0}catch(y){return console.error("Error checking stale auth data:",y),!0}};class V{constructor(){x(this,"adjectives",["Swift","Bright","Clever","Bold","Calm","Cool","Fast","Kind","Smart","Wise","Brave","Gentle","Happy","Lucky","Magic","Pure","Quick","Sharp","Strong","Sweet","True","Wild","Young","Zest","Epic","Noble","Radiant","Vibrant","Dynamic","Elegant","Fierce","Golden","Harmonic","Infinite","Jovial","Keen","Luminous","Mystic","Serene","Vivid","Cosmic","Prismatic","Ethereal","Celestial"]);x(this,"nouns",["Tiger","Eagle","Wolf","Bear","Fox","Hawk","Lion","Deer","Owl","Raven","Falcon","Shark","Dolphin","Phoenix","Dragon","Unicorn","Pegasus","Griffin","Sphinx","Basilisk","Phoenix","Explorer","Navigator","Pioneer","Adventurer","Dreamer","Creator","Builder","Artist","Writer","Sage","Mage","Warrior","Guardian","Wanderer","Seeker","Thinker","Innovator","Visionary","Legend","Philosopher","Inventor","Scholar","Mentor","Guide","Champion"]);x(this,"colors",["Red","Blue","Green","Yellow","Purple","Orange","Pink","Cyan","Magenta","Lime","Indigo","Teal","Coral","Gold","Silver","Copper","Emerald","Ruby","Sapphire","Amber","Pearl","Crystal","Shadow","Light","Dark","Bright","Deep","Rich","Vivid","Pastel","Azure","Crimson","Violet","Turquoise","Scarlet","Ivory","Ebony"])}generateAnonymousHandle(){return m(this,arguments,function*(e={}){const{prefix:r="",includeNumbers:h=!0,format:n="random",maxLength:u=20}=e;let o,d=0;const c=10;do o=this.generateHandle(n,h),r&&(o=r+o),o.length>u&&(o=o.substring(0,u)),d++;while(d<c&&!(yield this.isHandleUnique(o)));if(d>=c){const A=Math.floor(Math.random()*9999);o=o.substring(0,u-4)+A}return{username:o,displayName:o,isGenerated:!0,isUnique:yield this.isHandleUnique(o)}})}generateHandle(e,r){const h=this.getRandomElement(this.adjectives),n=this.getRandomElement(this.nouns),u=this.getRandomElement(this.colors),o=r?Math.floor(Math.random()*9999)+1:"";switch(e){case"adjective-noun":return h+n+o;case"color-noun":return u+n+o;case"adjective-color":return h+u+o;case"noun-color":return n+u+o;case"random":default:{const d=["adjective-noun","color-noun","adjective-color","noun-color"],c=d[Math.floor(Math.random()*d.length)];return this.generateHandle(c,r)}}}getRandomElement(e){return e[Math.floor(Math.random()*e.length)]}isHandleUnique(e){return m(this,null,function*(){try{const{data:r,error:h}=yield U.from("profiles").select("username").eq("username",e).single();return h&&h.code==="PGRST116"?!0:(h&&console.error("Error checking handle uniqueness:",h),!1)}catch(r){return console.error("Error in isHandleUnique:",r),!1}})}validateHandle(e){const r=[];return(!e||e.trim().length===0)&&r.push("Username cannot be empty"),e.length<3&&r.push("Username must be at least 3 characters long"),e.length>30&&r.push("Username cannot exceed 30 characters"),/^[a-zA-Z0-9_-]+$/.test(e)||r.push("Username can only contain letters, numbers, underscores, and hyphens"),["admin","administrator","moderator","mod","support","help","api","www","mail","email","root","user","guest","anonymous","null","undefined","true","false","system","service"].includes(e.toLowerCase())&&r.push("This username is reserved and cannot be used"),["damn","hell","shit","fuck","bitch","ass"].some(u=>e.toLowerCase().includes(u))&&r.push("Username contains inappropriate content"),{isValid:r.length===0,errors:r}}generateHandleSuggestions(){return m(this,arguments,function*(e=5,r={}){const h=[],n=new Set;for(let u=0;u<e*2&&!(h.length>=e);u++){const o=yield this.generateAnonymousHandle(r);n.has(o.username)||(n.add(o.username),h.push(o))}return h.slice(0,e)})}createAnonymousHandleForUser(h){return m(this,arguments,function*(e,r={}){try{const n=yield this.generateAnonymousHandle(r),u=this.validateHandle(n.username);if(!u.isValid)return{success:!1,error:`Invalid handle: ${u.errors.join(", ")}`};if(!(yield this.isHandleUnique(n.username)))return{success:!1,error:"Generated handle is not unique"};const{data:d,error:c}=yield U.from("profiles").update({username:n.username,display_name:n.displayName,is_anonymous:!0,privacy_level:"anonymous",updated_at:new Date().toISOString()}).eq("user_id",e).select().single();return c?(console.error("Error updating profile with anonymous handle:",c),{success:!1,error:c.message}):{success:!0,handle:{username:d.username,displayName:d.display_name,isGenerated:!0,isUnique:!0}}}catch(n){return console.error("Error creating anonymous handle for user:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}})}regenerateAnonymousHandle(h){return m(this,arguments,function*(e,r={}){try{const n=yield this.generateAnonymousHandle(r),u=this.validateHandle(n.username);if(!u.isValid)return{success:!1,error:`Invalid handle: ${u.errors.join(", ")}`};if(!(yield this.isHandleUnique(n.username)))return{success:!1,error:"Generated handle is not unique"};const{data:d,error:c}=yield U.from("profiles").update({username:n.username,display_name:n.displayName,updated_at:new Date().toISOString()}).eq("user_id",e).select().single();return c?(console.error("Error updating profile with new anonymous handle:",c),{success:!1,error:c.message}):{success:!0,handle:{username:d.username,displayName:d.display_name,isGenerated:!0,isUnique:!0}}}catch(n){return console.error("Error regenerating anonymous handle:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}})}getHandleStatistics(){return m(this,null,function*(){try{const{data:e,error:r}=yield U.from("profiles").select("username, is_anonymous, privacy_level");if(r)return console.error("Error fetching handle statistics:",r),{totalHandles:0,anonymousHandles:0,publicHandles:0,uniquePrefixes:[]};const h=(e==null?void 0:e.length)||0,n=(e==null?void 0:e.filter(d=>d.is_anonymous).length)||0,u=(e==null?void 0:e.filter(d=>d.privacy_level==="public").length)||0,o=new Set;return e==null||e.forEach(d=>{var A;const c=(A=d.username)==null?void 0:A.split(/[0-9_-]/)[0];c&&c.length>2&&o.add(c)}),{totalHandles:h,anonymousHandles:n,publicHandles:u,uniquePrefixes:Array.from(o)}}catch(e){return console.error("Error in getHandleStatistics:",e),{totalHandles:0,anonymousHandles:0,publicHandles:0,uniquePrefixes:[]}}})}}const Y=new V,se=v.memo(({children:y})=>{const[e,r]=v.useState(null),[h,n]=v.useState(null),[u,o]=v.useState(!0),[d,c]=v.useState(navigator.onLine),[A,E]=v.useState("connecting"),{toast:a}=T();v.useEffect(()=>{const s=()=>{c(!0),E("connecting"),j().then(t=>{t?(E("connected"),initializeAuth()):E("failed")})},i=()=>{c(!1),E("offline")};return window.addEventListener("online",s),window.addEventListener("offline",i),()=>{window.removeEventListener("online",s),window.removeEventListener("offline",i)}},[]),v.useEffect(()=>{const i=setInterval(()=>{const t=$();E(t)},5e3);return()=>clearInterval(i)},[]),v.useEffect(()=>{let s=!0;m(null,null,function*(){var f,l;try{if(console.log("Initializing authentication..."),B()){console.log("Stale authentication data detected, clearing..."),H(),s&&(n(null),r(null),o(!1));return}if(!navigator.onLine){console.warn("Network is offline, using cached session"),E("offline");const g=localStorage.getItem("supabase.auth.token");if(g)try{const w=JSON.parse(g);s&&(n(w),r((f=w==null?void 0:w.user)!=null?f:null),o(!1))}catch(w){console.error("Failed to parse cached session:",w),H()}else o(!1);return}const{data:k,error:p}=yield _(()=>m(null,null,function*(){const{data:{session:g},error:w}=yield P.auth.getSession();if(w)throw w;return g}),null,"Failed to get session during initialization");if(p){console.error("Error getting session:",p),E("failed"),s&&(n(null),r(null),o(!1)),a({title:"Connection Issue",description:"Unable to connect to authentication service. Some features may be limited.",variant:"destructive"});return}const S=k;if(S&&S.expires_at&&new Date(S.expires_at*1e3)<new Date){console.log("Session has expired, clearing auth state"),s&&(n(null),r(null),o(!1));return}s&&(n(S),r((l=S==null?void 0:S.user)!=null?l:null),o(!1),E("connected"))}catch(k){console.error("Error during auth initialization:",k),E("failed"),s&&(n(null),r(null),o(!1)),a({title:"Authentication Error",description:"Failed to initialize authentication. Please refresh the page.",variant:"destructive"})}});const{data:{subscription:t}}=P.auth.onAuthStateChange((f,l)=>m(null,null,function*(){var k,p;console.log("Auth state changed:",f,(k=l==null?void 0:l.user)==null?void 0:k.id),s&&(n(l),r((p=l==null?void 0:l.user)!=null?p:null),o(!1),l?E("connected"):navigator.onLine?E("failed"):E("offline"))}));return()=>{s=!1,t.unsubscribe()}},[a]);const C=v.useCallback((s,i,t,f,l)=>m(null,null,function*(){var k;try{if(!navigator.onLine)return a({title:"Network Error",description:"Please check your internet connection and try again.",variant:"destructive"}),{error:new Error("Network offline")};const{data:p,error:S}=yield _(()=>m(null,null,function*(){const{data:g,error:w}=yield P.auth.signUp({email:s,password:i,options:{data:{first_name:t,last_name:f,user_type:l||"user"}}});if(w)throw w;return g}),null,"Sign up failed");if(S){const g=S.message||"An unexpected error occurred";return console.error("Sign up error:",S),a({title:"Sign Up Failed",description:g,variant:"destructive"}),{error:new Error(g)}}if(p!=null&&p.user){if(p.session)try{yield new Promise(w=>setTimeout(w,1e3));const g=yield R.getUserProfile(p.user.id);if(!g.profile)console.log("Profile not found, creating manually..."),yield R.createUserProfile({user_id:p.user.id,user_type:l||"user",display_name:`${t||""} ${f||""}`.trim()||s,first_name:t,last_name:f});else{console.log("Creating anonymous handle for new user...");const w=yield Y.createAnonymousHandleForUser(p.user.id,{format:"random",includeNumbers:!0,maxLength:20});if(w.success?console.log("Anonymous handle created:",(k=w.handle)==null?void 0:k.username):console.warn("Failed to create anonymous handle:",w.error),g.profile.user_type!==(l||"user")||!g.profile.first_name||!g.profile.last_name||!g.profile.display_name){console.log("Updating profile with missing fields...");const{error:b}=yield P.from("profiles").update({user_type:l||"user",first_name:t||g.profile.first_name,last_name:f||g.profile.last_name,display_name:g.profile.display_name||`${t||""} ${f||""}`.trim()||s}).eq("user_id",p.user.id);b&&console.error("Error updating profile:",b)}if((l||"user")==="artist"&&!g.artistProfile){console.log("Creating artist profile...");const{error:b}=yield P.from("artists").insert({user_id:p.user.id,specialty:[],experience_years:0,portfolio_urls:[],bio:"Professional artist - completing profile setup...",is_available:!0});b&&console.error("Error creating artist profile:",b)}}}catch(g){console.error("Error ensuring profile exists:",g)}p.session?a({title:"Welcome!",description:`Account created successfully as ${l||"user"}.`}):a({title:"Sign Up Successful",description:"Please check your email to verify your account."})}return{error:null}}catch(p){const S=p instanceof Error?p.message:"An unexpected error occurred";return console.error("Sign up error:",p),a({title:"Sign Up Failed",description:S,variant:"destructive"}),{error:new Error(S)}}}),[a]),I=v.useCallback((s,i)=>m(null,null,function*(){try{if(!navigator.onLine)return a({title:"Network Error",description:"Please check your internet connection and try again.",variant:"destructive"}),{error:new Error("Network offline")};const{data:t,error:f}=yield _(()=>m(null,null,function*(){const{data:l,error:k}=yield P.auth.signInWithPassword({email:s,password:i});if(k)throw k;return l}),null,"Sign in failed");if(f){const l=f.message||"An unexpected error occurred";return console.error("Sign in error:",f),a({title:"Sign In Failed",description:l,variant:"destructive"}),{error:new Error(l)}}return t!=null&&t.user&&a({title:"Welcome Back!",description:`Signed in as ${t.user.email}`}),{error:null}}catch(t){const f=t instanceof Error?t.message:"An unexpected error occurred";return console.error("Sign in error:",t),a({title:"Sign In Failed",description:f,variant:"destructive"}),{error:new Error(f)}}}),[a]),q=v.useCallback(s=>m(null,null,function*(){try{if(!navigator.onLine)return a({title:"Network Error",description:"Please check your internet connection and try again.",variant:"destructive"}),{error:new Error("Network offline")};const{data:i,error:t}=yield _(()=>m(null,null,function*(){const{data:f,error:l}=yield P.auth.signInWithOAuth({provider:s,options:{redirectTo:`${window.location.origin}/auth/callback`}});if(l)throw l;return f}),null,"OAuth sign in failed");if(t){const f=t.message||"An unexpected error occurred";return console.error("OAuth sign in error:",t),a({title:"OAuth Sign In Failed",description:f,variant:"destructive"}),{error:new Error(f)}}return{error:null}}catch(i){const t=i instanceof Error?i.message:"An unexpected error occurred";return console.error("OAuth sign in error:",i),a({title:"OAuth Sign In Failed",description:t,variant:"destructive"}),{error:new Error(t)}}}),[a]),F=v.useCallback(()=>m(null,null,function*(){try{const{error:s}=yield _(()=>m(null,null,function*(){const{error:i}=yield P.auth.signOut();if(i)throw i;return{success:!0}}),{success:!1},"Sign out failed");s?(console.error("Sign out error:",s),a({title:"Sign Out Failed",description:"There was an error signing you out.",variant:"destructive"})):a({title:"Signed Out",description:"You have been successfully signed out."})}catch(s){console.error("Sign out error:",s),a({title:"Sign Out Failed",description:"There was an error signing you out.",variant:"destructive"})}}),[a]),M=v.useCallback(s=>m(null,null,function*(){try{if(!navigator.onLine)return a({title:"Network Error",description:"Please check your internet connection and try again.",variant:"destructive"}),{error:new Error("Network offline")};const{error:i}=yield _(()=>m(null,null,function*(){const{error:t}=yield P.auth.resetPasswordForEmail(s,{redirectTo:`${window.location.origin}/auth/reset-password`});if(t)throw t;return{success:!0}}),{success:!1},"Password reset request failed");if(i){const t=i.message||"An unexpected error occurred";return console.error("Password reset request error:",i),a({title:"Password Reset Failed",description:t,variant:"destructive"}),{error:new Error(t)}}return a({title:"Password Reset Email Sent",description:"Check your email for password reset instructions."}),{error:null}}catch(i){const t=i instanceof Error?i.message:"An unexpected error occurred";return console.error("Password reset request error:",i),a({title:"Password Reset Failed",description:t,variant:"destructive"}),{error:new Error(t)}}}),[a]),L=v.useCallback((s,i)=>m(null,null,function*(){try{if(!navigator.onLine)return a({title:"Network Error",description:"Please check your internet connection and try again.",variant:"destructive"}),{error:new Error("Network offline")};if(i.length<12)return a({title:"Password Too Weak",description:"Password must be at least 12 characters long.",variant:"destructive"}),{error:new Error("Password too weak")};const{error:t}=yield P.auth.updateUser({password:i});return t?(a({title:"Password Reset Failed",description:t.message||"Failed to reset password",variant:"destructive"}),{error:new Error(t.message)}):(a({title:"Password Updated",description:"Your password has been successfully updated."}),{error:null})}catch(t){const f=t instanceof Error?t.message:"An unexpected error occurred";return console.error("Password reset error:",t),a({title:"Password Reset Failed",description:f,variant:"destructive"}),{error:new Error(f)}}}),[a]),O=v.useCallback(()=>{H(),r(null),n(null),a({title:"Auth Data Cleared",description:"Authentication data has been cleared. Please sign in again."})},[a]),D=v.useMemo(()=>({user:e,session:h,loading:u,isOnline:d,connectionStatus:A,signUp:C,signIn:I,signInWithOAuth:q,signOut:F,requestPasswordReset:M,resetPassword:L,clearAuthData:O}),[e,h,u,d,A,C,I,q,F,M,L,O]);return N.jsx(z.Provider,{value:D,children:y})});export{se as AuthProvider};
