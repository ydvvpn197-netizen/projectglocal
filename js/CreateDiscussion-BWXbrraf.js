var F=Object.defineProperty,G=Object.defineProperties;var T=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var w=(n,r,t)=>r in n?F(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t,S=(n,r)=>{for(var t in r||(r={}))q.call(r,t)&&w(n,t,r[t]);if(N)for(var t of N(r))L.call(r,t)&&w(n,t,r[t]);return n},b=(n,r)=>G(n,T(r));var x=(n,r,t)=>new Promise((h,c)=>{var l=s=>{try{u(t.next(s))}catch(g){c(g)}},d=s=>{try{u(t.throw(s))}catch(g){c(g)}},u=s=>s.done?h(s.value):Promise.resolve(s.value).then(l,d);u((t=t.apply(n,r)).next())});import{r as p,u as I,g as k,s as v,f as P,j as e,B as C,C as R,p as B,q as U,t as V,v as M}from"./main-jfCIwKxb.js";import{I as Y}from"./index-DGobKVbi.js";import{T as z}from"./textarea-Dm2RgXBl.js";import{S as E,a as _,b as D,c as A,d as f}from"./select-BK9ujtwJ.js";import{L as y}from"./label-BhjyL16S.js";import{C as H}from"./checkbox-D1uUBoVG.js";import{R as Q}from"./ResponsiveLayout-Dd-U-XTf.js";import{u as W}from"./useLocation-Dro6x-la.js";import{A as J}from"./arrow-left-BUiGB43w.js";import{M as K}from"./message-circle-BzbuDOEE.js";import"./index-CaL9moq2.js";import"./index-BqrjOP3n.js";import"./chevron-up-DhaGujCg.js";import"./check-CWeqS_MX.js";import"./separator-CQeeh5sy.js";import"./index-D6sgUugm.js";import"./databaseUtils-Cc-GydU0.js";import"./badge-Cxniq3nT.js";import"./scroll-area-Bsyy6uVd.js";import"./index-DCmZQWeX.js";import"./tabs-Bho2AISw.js";import"./useNotifications-DlynYvan.js";import"./notificationService-DPR46Nx3.js";import"./bell-CXNc_0l5.js";import"./user-cZSM4iEh.js";import"./search-DIpOLffQ.js";import"./calendar-CXbnSY_4.js";import"./alert-f_BC70aV.js";import"./zap-C2TAeX5H.js";import"./plus-Bi3vU8QF.js";import"./message-square-oWFCH1Pi.js";import"./map-pin-B5hnRU36.js";import"./wifi-Ue5kLFZw.js";import"./log-out-CxjypOOW.js";import"./locationService-D_4XBFWa.js";const O=()=>{const[n,r]=p.useState([]),[t,h]=p.useState(!0),{user:c}=I(),{toast:l}=k(),{currentLocation:d}=W(),u=p.useCallback(()=>x(void 0,null,function*(){try{h(!0);const{data:a,error:o}=yield v.rpc("get_discussions_with_details");if(o)throw o;r(a||[])}catch(a){console.error("Error fetching discussions:",a),l({title:"Error",description:"Failed to fetch discussions",variant:"destructive"})}finally{h(!1)}}),[l]),s=a=>x(void 0,null,function*(){if(!c)return l({title:"Error",description:"You must be logged in to create discussions",variant:"destructive"}),!1;try{const{error:o}=yield v.from("discussions").insert({user_id:c.id,title:a.title,content:a.content,category:a.category||"general",is_anonymous:a.is_anonymous||!1,group_id:a.group_id||null,latitude:d==null?void 0:d.latitude,longitude:d==null?void 0:d.longitude});if(o)throw o;return l({title:"Success",description:"Discussion created successfully!"}),u(),!0}catch(o){return console.error("Error creating discussion:",o),l({title:"Error",description:"Failed to create discussion",variant:"destructive"}),!1}});return p.useEffect(()=>{c&&u()},[c,u]),{discussions:n,loading:t,createDiscussion:s,deleteDiscussion:a=>x(void 0,null,function*(){if(!c)return{error:new Error("Not authenticated")};try{const{error:o}=yield v.from("discussions").delete().eq("id",a).eq("user_id",c.id);if(o)throw o;return l({title:"Discussion deleted",description:"Your discussion has been deleted successfully."}),u(),{error:null}}catch(o){return l({title:"Error deleting discussion",description:o.message,variant:"destructive"}),{error:o}}}),refetch:u}},Ge=()=>{const n=P(),{toast:r}=k(),{user:t}=I(),{createDiscussion:h}=O(),[c,l]=p.useState(!1),[d,u]=p.useState([]),[s,g]=p.useState({title:"",content:"",groupId:"",category:"general",isAnonymous:!1});p.useEffect(()=>{x(void 0,null,function*(){if(t)try{const{data:m,error:j}=yield v.from("community_groups").select(`
            id,
            name,
            description,
            category,
            group_members!inner (role)
          `).eq("group_members.user_id",t.id);if(j)throw j;u(m||[])}catch(m){console.error("Error fetching user groups:",m)}})},[t]);const a=i=>x(void 0,null,function*(){if(i.preventDefault(),!!t){if(!s.title.trim()||!s.content.trim()){r({title:"Error",description:"Please fill in title and content.",variant:"destructive"});return}if(!s.isAnonymous&&!s.groupId){r({title:"Error",description:"Please select a group or choose anonymous discussion.",variant:"destructive"});return}l(!0);try{(yield h({title:s.title,content:s.content,category:s.category,is_anonymous:s.isAnonymous,group_id:s.isAnonymous?void 0:s.groupId}))&&n("/community")}catch(m){console.error("Error creating discussion:",m)}finally{l(!1)}}}),o=(i,m)=>{g(j=>b(S({},j),{[i]:m}))};return e.jsx(Q,{children:e.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(C,{variant:"ghost",size:"sm",onClick:()=>n("/community"),className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Back to Community"]})}),e.jsxs(R,{children:[e.jsxs(B,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-6 w-6 text-primary"}),e.jsx(U,{className:"text-2xl",children:"Start a Discussion"})]}),e.jsx(V,{children:"Share your thoughts and engage with your community"})]}),e.jsx(M,{children:e.jsxs("form",{onSubmit:a,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{id:"anonymous",checked:s.isAnonymous,onCheckedChange:i=>o("isAnonymous",i)}),e.jsx(y,{htmlFor:"anonymous",className:"text-sm font-medium",children:"Post anonymously (without joining a group)"})]}),!s.isAnonymous&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"group",children:"Group *"}),e.jsxs(E,{value:s.groupId,onValueChange:i=>o("groupId",i),children:[e.jsx(_,{children:e.jsx(D,{placeholder:"Select a group to post in"})}),e.jsx(A,{children:d.map(i=>e.jsx(f,{value:i.id,children:i.name},i.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"title",children:"Discussion Title *"}),e.jsx(Y,{id:"title",placeholder:"What would you like to discuss?",value:s.title,onChange:i=>o("title",i.target.value),className:"text-lg"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"content",children:"Description *"}),e.jsx(z,{id:"content",placeholder:"Provide more details about your discussion...",value:s.content,onChange:i=>o("content",i.target.value),rows:6})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"category",children:"Category"}),e.jsxs(E,{value:s.category,onValueChange:i=>o("category",i),children:[e.jsx(_,{children:e.jsx(D,{})}),e.jsxs(A,{children:[e.jsx(f,{value:"general",children:"General"}),e.jsx(f,{value:"question",children:"Question"}),e.jsx(f,{value:"event",children:"Event"}),e.jsx(f,{value:"recommendation",children:"Recommendation"}),e.jsx(f,{value:"announcement",children:"Announcement"})]})]})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>n("/community"),className:"flex-1",children:"Cancel"}),e.jsx(C,{type:"submit",disabled:c||!s.title.trim()||!s.content.trim()||!s.isAnonymous&&!s.groupId,className:"flex-1",children:c?"Creating...":"Start Discussion"})]})]})})]})]})})};export{Ge as default};
