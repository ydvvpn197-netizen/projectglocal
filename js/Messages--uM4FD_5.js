var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,l=(e,s,t)=>new Promise((r,i)=>{var a=e=>{try{l(t.next(e))}catch(s){i(s)}},n=e=>{try{l(t.throw(e))}catch(s){i(s)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,n);l((t=t.apply(e,s)).next())});import{u as o,d as c,b as d,r as m,s as u,j as p,C as j,y as x,B as h}from"./main-u5iDOJMZ.js";import{R as v}from"./ResponsiveLayout-CaFEj6Sr.js";import{T as f,a as y,b as _,c as N}from"./tabs-Dn7YRzvT.js";import{A as b,a as g,b as w}from"./sheet-BES5Q-Ko.js";import{B as q}from"./badge-k0SsuPwB.js";import{M as O}from"./message-circle-nfkvwkJk.js";import{f as P}from"./index-azXaBhbR.js";import"./input-d0wpgTJ2.js";import"./separator-BdZu64Yb.js";import"./NotificationBell-4ukuyDx4.js";import"./Combination-D3NAapk3.js";import"./scroll-area-DANvZfFy.js";import"./index-Dy-VqNBB.js";import"./index-jVOyRz7F.js";import"./useNotifications-DNCpc7NU.js";import"./check-CT-bNmTi.js";import"./bell-wBykza9e.js";import"./user-DlaYKRnl.js";import"./NotificationButton-QcrDLMMB.js";import"./search-BsWmJlwB.js";import"./map-pin-CcmxiK6P.js";import"./index-B7-3ofi9.js";import"./users-BKDXsamp.js";import"./zap-BrBeKdrO.js";import"./message-square-DQ5316cR.js";import"./alert-7nHfBPfv.js";import"./wifi-DNTf1l7S.js";import"./log-out-CGc8M4_-.js";const S=()=>{const{user:e}=o(),{toast:S}=c(),R=d(),[k,C]=m.useState(!0),[D,A]=m.useState([]),[B,E]=m.useState([]);m.useEffect(()=>{e&&z()},[null==e?void 0:e.id]);const z=()=>l(void 0,null,function*(){if(e){C(!0);try{const{data:l,error:o}=yield u.from("chat_conversations").select("*").or(`client_id.eq.${e.id},artist_id.eq.${e.id}`).order("updated_at",{ascending:!1});if(o)throw o;const c=l||[],d=c.map(s=>s.client_id===e.id?s.artist_id:s.client_id),{data:m}=yield u.from("profiles").select("user_id, display_name, avatar_url").in("user_id",d),p=new Map((m||[]).map(e=>[e.user_id,e])),j=c.map(l=>((e,r)=>s(e,t(r)))(((e,s)=>{for(var t in s||(s={}))i.call(s,t)&&n(e,t,s[t]);if(r)for(var t of r(s))a.call(s,t)&&n(e,t,s[t]);return e})({},l),{other_user:p.get(l.client_id===e.id?l.artist_id:l.client_id)}));A(j.filter(e=>"active"===e.status)),E(j.filter(s=>"pending"===s.status&&s.client_id!==e.id))}catch(l){S({title:"Error",description:l.message||"Failed to load messages",variant:"destructive"})}finally{C(!1)}}});return p.jsx(v,{children:p.jsxs("div",{className:"container max-w-4xl mx-auto p-6",children:[p.jsxs("div",{className:"mb-6",children:[p.jsx("h1",{className:"text-2xl font-bold",children:"Messages"}),p.jsx("p",{className:"text-muted-foreground",children:"Chat with your connections. Requests must be accepted before chatting."})]}),p.jsxs(f,{defaultValue:"active",children:[p.jsxs(y,{children:[p.jsx(_,{value:"active",children:"Active"}),p.jsx(_,{value:"requests",children:"Requests"})]}),p.jsx(N,{value:"active",className:"mt-4",children:k?p.jsx("div",{className:"flex items-center justify-center py-12",children:p.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):0===D.length?p.jsx(j,{children:p.jsxs(x,{className:"text-center py-12 text-muted-foreground",children:[p.jsx(O,{className:"h-10 w-10 mx-auto mb-2"}),"No active conversations"]})}):p.jsx("div",{className:"space-y-3",children:D.map(e=>{var s,t,r,i;return p.jsx(j,{className:"cursor-pointer hover:shadow-md",onClick:()=>R(`/chat/${e.id}`),children:p.jsxs(x,{className:"p-4 flex items-center gap-3",children:[p.jsxs(b,{children:[p.jsx(g,{src:null==(s=e.other_user)?void 0:s.avatar_url}),p.jsx(w,{children:(null==(r=null==(t=e.other_user)?void 0:t.display_name)?void 0:r.charAt(0))||"U"})]}),p.jsxs("div",{className:"flex-1",children:[p.jsxs("div",{className:"flex items-center gap-2",children:[p.jsx("span",{className:"font-medium",children:(null==(i=e.other_user)?void 0:i.display_name)||"User"}),e.booking_id&&p.jsx(q,{variant:"secondary",children:"Booking"})]}),p.jsxs("div",{className:"text-xs text-muted-foreground",children:["Started ",P(new Date(e.created_at),"PPp")]})]}),p.jsx(h,{variant:"outline",size:"sm",children:"Open"})]})},e.id)})})}),p.jsx(N,{value:"requests",className:"mt-4",children:k?p.jsx("div",{className:"flex items-center justify-center py-12",children:p.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):0===B.length?p.jsx(j,{children:p.jsxs(x,{className:"text-center py-12 text-muted-foreground",children:[p.jsx(O,{className:"h-10 w-10 mx-auto mb-2"}),"No pending requests"]})}):p.jsx("div",{className:"space-y-3",children:B.map(e=>{var s,t,r,i;return p.jsx(j,{children:p.jsxs(x,{className:"p-4 flex items-center gap-3",children:[p.jsxs(b,{children:[p.jsx(g,{src:null==(s=e.other_user)?void 0:s.avatar_url}),p.jsx(w,{children:(null==(r=null==(t=e.other_user)?void 0:t.display_name)?void 0:r.charAt(0))||"U"})]}),p.jsxs("div",{className:"flex-1",children:[p.jsx("div",{className:"font-medium",children:(null==(i=e.other_user)?void 0:i.display_name)||"User"}),p.jsxs("div",{className:"text-xs text-muted-foreground",children:["Requested ",P(new Date(e.created_at),"PPp")]})]}),p.jsxs("div",{className:"flex gap-2",children:[p.jsx(h,{size:"sm",onClick:()=>(e=>l(void 0,null,function*(){const{error:s}=yield u.from("chat_conversations").update({status:"active",updated_at:(new Date).toISOString()}).eq("id",e);s?S({title:"Error",description:"Failed to accept request",variant:"destructive"}):(z(),S({title:"Request accepted"}))}))(e.id),children:"Accept"}),p.jsx(h,{size:"sm",variant:"outline",onClick:()=>(e=>l(void 0,null,function*(){const{error:s}=yield u.from("chat_conversations").update({status:"closed",updated_at:(new Date).toISOString()}).eq("id",e);s?S({title:"Error",description:"Failed to decline request",variant:"destructive"}):(z(),S({title:"Request declined"}))}))(e.id),children:"Decline"})]})]})},e.id)})})})]})]})})};export{S as default};
