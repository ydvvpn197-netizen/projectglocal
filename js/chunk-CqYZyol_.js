var N=Object.defineProperty,B=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var M=(S,t,e)=>t in S?N(S,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[t]=e,k=(S,t)=>{for(var e in t||(t={}))z.call(t,e)&&M(S,e,t[e]);if(q)for(var e of q(t))L.call(t,e)&&M(S,e,t[e]);return S},D=(S,t)=>B(S,j(t));var A=(S,t,e)=>M(S,typeof t!="symbol"?t+"":t,e);var m=(S,t,e)=>new Promise((o,s)=>{var r=w=>{try{h(e.next(w))}catch(a){s(a)}},c=w=>{try{h(e.throw(w))}catch(a){s(a)}},h=w=>w.done?o(w.value):Promise.resolve(w.value).then(r,c);h((e=e.apply(S,t)).next())});import{r as y}from"./chunk-COTa-BBv.js";import{s as _}from"./chunk-CasIWBEQ.js";import{a as T}from"./main-BEfTDqLJ.js";class I{static generateFollowSuggestions(t,e,o,s,r,c=20){return r.filter(l=>l.id!==t&&!s.includes(l.id)).map(l=>{const f=this.calculateFollowRecommendationScores(t,e,o,l,r);return D(k({},l),{scores:f})}).sort((l,f)=>f.scores.finalScore-l.scores.finalScore).slice(0,c).map((l,f)=>({id:`suggestion_${l.id}_${f}`,userId:l.id,displayName:l.display_name||l.username||"Anonymous",avatarUrl:l.avatar_url,bio:l.bio||"",score:l.scores.finalScore,commonInterests:this.findCommonInterests(e,l.interests||[]),mutualFollowers:this.countMutualFollowers(t,l.id,r),location:l.location?{city:l.location.city||"",state:l.location.state||""}:null,reason:this.generateFollowReason(l.scores,l),createdAt:new Date().toISOString()}))}static calculateFollowRecommendationScores(t,e,o,s,r){const c=this.calculateSimilarityScore(e,s.interests||[]),h=this.calculateMutualConnectionsScore(t,s.id,r),w=this.calculateActivityScore(s),a=this.calculateLocationScore(o,s.location),l=this.calculateInterestOverlapScore(e,s.interests||[]),f=c*.25+h*.3+w*.2+a*.15+l*.1;return{similarityScore:c,mutualConnectionsScore:h,activityScore:w,locationScore:a,interestOverlapScore:l,finalScore:f}}static calculateSimilarityScore(t,e){if(t.length===0||e.length===0)return .5;const s=this.findCommonInterests(t,e).length/Math.max(t.length,e.length);return Math.min(s,1)}static calculateMutualConnectionsScore(t,e,o){const s=this.countMutualFollowers(t,e,o);return Math.min(s/50,1)}static calculateActivityScore(t){let e=.5;if(t.posts_count){const o=Math.min(t.posts_count/100,1);e+=o*.2}if(t.events_created_count){const o=Math.min(t.events_created_count/20,1);e+=o*.2}if(t.last_activity){const o=(new Date().getTime()-new Date(t.last_activity).getTime())/864e5;o<=7?e+=.3:o<=30?e+=.2:o<=90&&(e+=.1)}return Math.min(e,1)}static calculateLocationScore(t,e){if(!t||!e)return .5;if(t.city===e.city)return 1;if(t.state===e.state)return .7;if(e.latitude&&e.longitude){const o=this.calculateDistance(t.latitude,t.longitude,e.latitude,e.longitude);return Math.max(0,1-o/100)}return .3}static calculateInterestOverlapScore(t,e){if(t.length===0||e.length===0)return .5;const s=this.findCommonInterests(t,e).length/Math.min(t.length,e.length);return Math.min(s,1)}static findCommonInterests(t,e){const o=t.map(r=>r.toLowerCase()),s=e.map(r=>r.toLowerCase());return o.filter(r=>s.includes(r))}static countMutualFollowers(t,e,o){const s=o.find(a=>a.id===t),r=o.find(a=>a.id===e);if(!s||!r)return 0;const c=s.followers_count||0,h=r.followers_count||0,w=Math.min(c,h);return Math.floor(w*.1)}static calculateDistance(t,e,o,s){const c=this.deg2rad(o-t),h=this.deg2rad(s-e),w=Math.sin(c/2)*Math.sin(c/2)+Math.cos(this.deg2rad(t))*Math.cos(this.deg2rad(o))*Math.sin(h/2)*Math.sin(h/2);return 6371*(2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w)))}static deg2rad(t){return t*(Math.PI/180)}static generateFollowReason(t,e){const o=[];if(t.similarityScore>.7&&o.push("Similar interests"),t.mutualConnectionsScore>.5){const s=Math.floor(t.mutualConnectionsScore*50);o.push(`${s} mutual connections`)}return t.activityScore>.7?o.push("Very active"):t.activityScore>.5&&o.push("Active user"),t.locationScore>.8?o.push("Same city"):t.locationScore>.6&&o.push("Nearby"),t.interestOverlapScore>.6&&o.push("Shared interests"),o.length===0&&o.push("Recommended for you"),o.join(", ")}static getPopularUsers(t,e=10){return t.filter(o=>o.followers_count>0).sort((o,s)=>(s.followers_count||0)-(o.followers_count||0)).slice(0,e)}static getUsersByInterest(t,e,o=10){const s=e.toLowerCase();return t.filter(r=>(r.interests||[]).some(h=>h.toLowerCase().includes(s))).sort((r,c)=>(c.followers_count||0)-(r.followers_count||0)).slice(0,o)}static calculateFollowStats(t,e,o){const s=e.length,r=o.length,c=e.filter(n=>o.some(d=>d.id===n.id)).length,h=e.reduce((n,d)=>n+(d.engagement_count||0),0),w=s>0?h/s:0,a=new Date(Date.now()-720*60*60*1e3),l=e.filter(n=>new Date(n.followed_at||n.created_at)>a).length,f=s>0?l/s:0;return{userId:t,totalFollowers:s,totalFollowing:r,mutualFollowers:c,engagementRate:w,growthRate:f,lastUpdated:new Date().toISOString()}}static analyzeFollowNetwork(t,e,o){const s=new Set([...e.map(d=>d.id),...o.map(d=>d.id)]).size,r=s*(s-1)/2,c=e.length+o.length,h=r>0?c/r:0,w=[...e,...o].filter(d=>(d.followers_count||0)>1e3).length,a=[...e,...o].flatMap(d=>d.interests||[]),l={};a.forEach(d=>{l[d]=(l[d]||0)+1});const f=Object.entries(l).filter(([d,F])=>F>1).sort(([d,F],[v,E])=>E-F).slice(0,5).map(([d,F])=>d),n=[];return h<.1&&n.push("Consider following more people to expand your network"),w<5&&n.push("Connect with more influential users in your field"),f.length<3&&n.push("Diversify your interests to connect with more people"),{networkSize:s,networkDensity:h,influentialConnections:w,commonInterests:f,recommendations:n}}}const C=class C{static getInstance(){return C.instance||(C.instance=new C),C.instance}followUser(t,e){return m(this,null,function*(){const{data:o,error:s}=yield _.from("user_follows").insert({follower_id:t,following_id:e,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(s)throw new Error(`Failed to follow user: ${s.message}`);return o})}unfollowUser(t,e){return m(this,null,function*(){const{error:o}=yield _.from("user_follows").delete().eq("follower_id",t).eq("following_id",e);if(o)throw new Error(`Failed to unfollow user: ${o.message}`)})}getFollowStatus(t,e){return m(this,null,function*(){const{data:o}=yield _.from("user_follows").select("status").eq("follower_id",t).eq("following_id",e).single();return o?o.status:"not_following"})}getFollowers(t,e=20){return m(this,null,function*(){const{data:o}=yield _.from("user_follows").select(`
        *,
        follower:profiles!user_follows_follower_id_fkey(
          user_id,
          display_name,
          avatar_url,
          bio
        )
      `).eq("following_id",t).eq("status","active").order("created_at",{ascending:!1}).limit(e);return o||[]})}getFollowing(t,e=20){return m(this,null,function*(){const{data:o}=yield _.from("user_follows").select(`
        *,
        following:profiles!user_follows_following_id_fkey(
          user_id,
          display_name,
          avatar_url,
          bio
        )
      `).eq("follower_id",t).eq("status","active").order("created_at",{ascending:!1}).limit(e);return o||[]})}getFollowStats(t){return m(this,null,function*(){const{count:e}=yield _.from("user_follows").select("*",{count:"exact",head:!0}).eq("following_id",t).eq("status","active"),{count:o}=yield _.from("user_follows").select("*",{count:"exact",head:!0}).eq("follower_id",t).eq("status","active"),{data:s}=yield _.from("user_follows").select("follower_id").eq("following_id",t).eq("status","active"),{data:r}=yield _.from("user_follows").select("following_id").eq("follower_id",t).eq("status","active");return I.calculateFollowStats(t,s||[],r||[])})}getFollowSuggestions(t,e=10){return m(this,null,function*(){try{const o=yield this.getUserProfile(t),s=yield this.getAllUsers(t);return I.generateFollowSuggestions(t,o.interests,o.location,this.getExistingFollows(t),s,e)}catch(o){return console.error("Error getting follow suggestions:",o),[]}})}getPopularUsers(t=10){return m(this,null,function*(){try{const{data:e}=yield _.from("profiles").select(`
          user_id,
          display_name,
          avatar_url,
          bio,
          location_city,
          location_state
        `).order("created_at",{ascending:!1}).limit(t*2);if(!e)return[];const o=[];for(const s of e){const{count:r}=yield _.from("user_follows").select("*",{count:"exact",head:!0}).eq("following_id",s.user_id).eq("status","active");r&&r>5&&o.push({userId:s.user_id,displayName:s.display_name||"Anonymous",avatarUrl:s.avatar_url,bio:s.bio,mutualFollowers:0,commonInterests:[],location:s.location_city?{city:s.location_city,state:s.location_state||""}:void 0,score:r,reason:"Popular in your area"})}return o.sort((s,r)=>r.score-s.score).slice(0,t)}catch(e){return console.error("Error getting popular users:",e),[]}})}getUsersByInterest(t,e=10){return m(this,null,function*(){try{const{data:o}=yield _.from("posts").select("user_id").or(`content.ilike.%${t}%,title.ilike.%${t}%`).eq("status","active").limit(100);if(!o)return[];const s=[...new Set(o.map(c=>c.user_id))];if(s.length===0)return[];const{data:r}=yield _.from("profiles").select(`
          user_id,
          display_name,
          avatar_url,
          bio,
          location_city,
          location_state
        `).in("user_id",s).limit(e);return r?r.map(c=>({userId:c.user_id,displayName:c.display_name||"Anonymous",avatarUrl:c.avatar_url,bio:c.bio,mutualFollowers:0,commonInterests:[t],location:c.location_city?{city:c.location_city,state:c.location_state||""}:void 0,score:1,reason:`Interested in ${t}`})):[]}catch(o){return console.error("Error getting users by interest:",o),[]}})}getUserProfile(t){return m(this,null,function*(){try{const{data:e}=yield _.from("profiles").select("*").eq("id",t).single(),{data:o}=yield _.from("user_preferences").select("*").eq("user_id",t).single();return{id:t,interests:(o==null?void 0:o.interests)||[],location:(e==null?void 0:e.location)||null,skills:(e==null?void 0:e.skills)||[],bio:(e==null?void 0:e.bio)||""}}catch(e){return console.error("Error getting user profile:",e),{id:t,interests:[],location:null,skills:[],bio:""}}})}getAllUsers(t){return m(this,null,function*(){try{const{data:e}=yield _.from("user_follows").select("following_id").eq("follower_id",t).eq("status","active"),o=(e==null?void 0:e.map(r=>r.following_id))||[],{data:s}=yield _.from("profiles").select("*").neq("id",t).not("id","in",`(${o.join(",")})`);return s||[]}catch(e){return console.error("Error getting all users:",e),[]}})}getExistingFollows(t){return[]}};A(C,"instance");let U=C;const p=U.getInstance(),K=()=>{const[S,t]=y.useState([]),[e,o]=y.useState([]),[s,r]=y.useState(null),[c,h]=y.useState([]),[w,a]=y.useState(!1),[l,f]=y.useState(null),{user:n}=T(),d=y.useCallback(i=>m(null,null,function*(){if(!n&&!i)return;const u=i||n.id;a(!0),f(null);try{const g=yield p.getFollowers(u);t(g)}catch(g){f(g instanceof Error?g.message:"Failed to fetch followers"),console.error("Error fetching followers:",g)}finally{a(!1)}}),[n]),F=y.useCallback(i=>m(null,null,function*(){if(!n&&!i)return;const u=i||n.id;a(!0),f(null);try{const g=yield p.getFollowing(u);o(g)}catch(g){f(g instanceof Error?g.message:"Failed to fetch following"),console.error("Error fetching following:",g)}finally{a(!1)}}),[n]),v=y.useCallback(i=>m(null,null,function*(){if(!n&&!i)return;const u=i||n.id;a(!0),f(null);try{const g=yield p.getFollowStats(u);r(g)}catch(g){f(g instanceof Error?g.message:"Failed to fetch follow stats"),console.error("Error fetching follow stats:",g)}finally{a(!1)}}),[n]),E=y.useCallback(()=>m(null,null,function*(){if(n){a(!0),f(null);try{const i=yield p.getFollowSuggestions(n.id);h(i)}catch(i){f(i instanceof Error?i.message:"Failed to fetch suggestions"),console.error("Error fetching suggestions:",i)}finally{a(!1)}}}),[n]),x=y.useCallback(i=>m(null,null,function*(){if(n){a(!0),f(null);try{yield p.followUser(n.id,i),o(u=>[...u,{id:`${n.id}-${i}`,followerId:n.id,followingId:i,status:"active",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]),yield v()}catch(u){f(u instanceof Error?u.message:"Failed to follow user"),console.error("Error following user:",u)}finally{a(!1)}}}),[n,v]),O=y.useCallback(i=>m(null,null,function*(){if(n){a(!0),f(null);try{yield p.unfollowUser(n.id,i),o(u=>u.filter(g=>g.followingId!==i)),yield v()}catch(u){f(u instanceof Error?u.message:"Failed to unfollow user"),console.error("Error unfollowing user:",u)}finally{a(!1)}}}),[n,v]),$=y.useCallback(i=>m(null,null,function*(){if(!n)return"not_following";try{return yield p.getFollowStatus(n.id,i)}catch(u){return console.error("Error getting follow status:",u),"not_following"}}),[n]),P=y.useCallback((i=10)=>m(null,null,function*(){a(!0),f(null);try{return yield p.getPopularUsers(i)}catch(u){return f(u instanceof Error?u.message:"Failed to fetch popular users"),console.error("Error fetching popular users:",u),[]}finally{a(!1)}}),[]),R=y.useCallback((i,u=10)=>m(null,null,function*(){a(!0),f(null);try{return yield p.getUsersByInterest(i,u)}catch(g){return f(g instanceof Error?g.message:"Failed to fetch users by interest"),console.error("Error fetching users by interest:",g),[]}finally{a(!1)}}),[]),b=y.useCallback(i=>m(null,null,function*(){if(!n&&!i)return;const u=i||n.id;yield Promise.all([d(u),F(u),v(u)]),i||(yield E())}),[n,d,F,v,E]);return y.useEffect(()=>{n&&b()},[n,b]),{followers:S,following:e,followStats:s,suggestions:c,loading:w,error:l,fetchFollowers:d,fetchFollowing:F,fetchFollowStats:v,fetchSuggestions:E,followUser:x,unfollowUser:O,getFollowStatus:$,getPopularUsers:P,getUsersByInterest:R,refreshAll:b}};export{K as u};
