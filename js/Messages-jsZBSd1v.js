var F=Object.defineProperty,$=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var C=(t,a,r)=>a in t?F(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,R=(t,a)=>{for(var r in a||(a={}))L.call(a,r)&&C(t,r,a[r]);if(q)for(var r of q(a))O.call(a,r)&&C(t,r,a[r]);return t},A=(t,a)=>$(t,z(a));var j=(t,a,r)=>new Promise((h,m)=>{var v=c=>{try{u(r.next(c))}catch(p){m(p)}},f=c=>{try{u(r.throw(c))}catch(p){m(p)}},u=c=>c.done?h(c.value):Promise.resolve(c.value).then(v,f);u((r=r.apply(t,a)).next())});import{u as V,g as G,f as H,w as J,r as x,s as g,j as e,C as _,v as N,B as b}from"./main-jfCIwKxb.js";import{R as K,A as S,b as E,c as T}from"./ResponsiveLayout-Dd-U-XTf.js";import{T as Q,a as W,b as k,c as P}from"./tabs-Bho2AISw.js";import{B as X}from"./badge-Cxniq3nT.js";import{M as B}from"./message-circle-BzbuDOEE.js";import{f as D}from"./index-DCmZQWeX.js";import"./index-DGobKVbi.js";import"./separator-CQeeh5sy.js";import"./index-D6sgUugm.js";import"./index-CaL9moq2.js";import"./databaseUtils-Cc-GydU0.js";import"./scroll-area-Bsyy6uVd.js";import"./useNotifications-DlynYvan.js";import"./notificationService-DPR46Nx3.js";import"./bell-CXNc_0l5.js";import"./check-CWeqS_MX.js";import"./user-cZSM4iEh.js";import"./search-DIpOLffQ.js";import"./calendar-CXbnSY_4.js";import"./alert-f_BC70aV.js";import"./zap-C2TAeX5H.js";import"./plus-Bi3vU8QF.js";import"./message-square-oWFCH1Pi.js";import"./map-pin-B5hnRU36.js";import"./wifi-Ue5kLFZw.js";import"./log-out-CxjypOOW.js";const qe=()=>{const{user:t}=V(),{toast:a}=G(),r=H(),[h]=J(),[m,v]=x.useState(!0),[f,u]=x.useState([]),[c,p]=x.useState([]);x.useEffect(()=>{t&&y()},[t==null?void 0:t.id]),x.useEffect(()=>{const s=h.get("conversation");s&&t&&r(`/chat/${s}`)},[h,r,t]);const y=()=>j(void 0,null,function*(){if(t){v(!0);try{const{data:s,error:n}=yield g.from("chat_conversations").select("*").or(`client_id.eq.${t.id},artist_id.eq.${t.id}`).order("updated_at",{ascending:!1});if(n)throw n;const o=s||[],d=o.map(i=>i.client_id===t.id?i.artist_id:i.client_id),{data:l}=yield g.from("profiles").select("user_id, display_name, avatar_url").in("user_id",d),U=new Map((l||[]).map(i=>[i.user_id,i])),w=o.map(i=>A(R({},i),{other_user:U.get(i.client_id===t.id?i.artist_id:i.client_id)}));u(w.filter(i=>i.status==="active")),p(w.filter(i=>i.status==="pending"&&i.client_id!==t.id))}catch(s){console.error("Error loading conversations:",s),a({title:"Error",description:s.message||"Failed to load messages",variant:"destructive"})}finally{v(!1)}}}),I=s=>j(void 0,null,function*(){const{error:n}=yield g.from("chat_conversations").update({status:"active",updated_at:new Date().toISOString()}).eq("id",s);n?a({title:"Error",description:"Failed to accept request",variant:"destructive"}):(y(),a({title:"Request accepted"}))}),M=s=>j(void 0,null,function*(){const{error:n}=yield g.from("chat_conversations").update({status:"closed",updated_at:new Date().toISOString()}).eq("id",s);n?a({title:"Error",description:"Failed to decline request",variant:"destructive"}):(y(),a({title:"Request declined"}))});return e.jsx(K,{children:e.jsxs("div",{className:"container max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Chat with your connections. Requests must be accepted before chatting."})]}),e.jsxs(Q,{defaultValue:"active",children:[e.jsxs(W,{children:[e.jsx(k,{value:"active",children:"Active"}),e.jsx(k,{value:"requests",children:"Requests"})]}),e.jsx(P,{value:"active",className:"mt-4",children:m?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):f.length===0?e.jsx(_,{children:e.jsxs(N,{className:"text-center py-12 text-muted-foreground",children:[e.jsx(B,{className:"h-10 w-10 mx-auto mb-2"}),"No active conversations"]})}):e.jsx("div",{className:"space-y-3",children:f.map(s=>{var n,o,d,l;return e.jsx(_,{className:"cursor-pointer hover:shadow-md",onClick:()=>r(`/chat/${s.id}`),children:e.jsxs(N,{className:"p-4 flex items-center gap-3",children:[e.jsxs(S,{children:[e.jsx(E,{src:(n=s.other_user)==null?void 0:n.avatar_url}),e.jsx(T,{children:((d=(o=s.other_user)==null?void 0:o.display_name)==null?void 0:d.charAt(0))||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:((l=s.other_user)==null?void 0:l.display_name)||"User"}),s.booking_id&&e.jsx(X,{variant:"secondary",children:"Booking"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Started ",D(new Date(s.created_at),"PPp")]})]}),e.jsx(b,{variant:"outline",size:"sm",children:"Open"})]})},s.id)})})}),e.jsx(P,{value:"requests",className:"mt-4",children:m?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):c.length===0?e.jsx(_,{children:e.jsxs(N,{className:"text-center py-12 text-muted-foreground",children:[e.jsx(B,{className:"h-10 w-10 mx-auto mb-2"}),"No pending requests"]})}):e.jsx("div",{className:"space-y-3",children:c.map(s=>{var n,o,d,l;return e.jsx(_,{children:e.jsxs(N,{className:"p-4 flex items-center gap-3",children:[e.jsxs(S,{children:[e.jsx(E,{src:(n=s.other_user)==null?void 0:n.avatar_url}),e.jsx(T,{children:((d=(o=s.other_user)==null?void 0:o.display_name)==null?void 0:d.charAt(0))||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:((l=s.other_user)==null?void 0:l.display_name)||"User"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Requested ",D(new Date(s.created_at),"PPp")]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",onClick:()=>I(s.id),children:"Accept"}),e.jsx(b,{size:"sm",variant:"outline",onClick:()=>M(s.id),children:"Decline"})]})]})},s.id)})})})]})]})})};export{qe as default};
