var L=Object.defineProperty,z=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var S=(n,t,s)=>t in n?L(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s,h=(n,t)=>{for(var s in t||(t={}))P.call(t,s)&&S(n,s,t[s]);if(_)for(var s of _(t))$.call(t,s)&&S(n,s,t[s]);return n},k=(n,t)=>z(n,H(t));var g=(n,t,s)=>new Promise((y,w)=>{var u=l=>{try{c(s.next(l))}catch(f){w(f)}},d=l=>{try{c(s.throw(l))}catch(f){w(f)}},c=l=>l.done?y(l.value):Promise.resolve(l.value).then(u,d);c((s=s.apply(n,t)).next())});import{r as i}from"./chunk-COTa-BBv.js";import{s as m}from"./chunk-CasIWBEQ.js";import{a as j,u as B}from"./main-BMj1NFFE.js";const K=(n={})=>{const{user:t}=j(),{toast:s}=B(),{realtime:y=!0,autoMarkAsRead:w=!1,batchSize:u=20}=n,[d,c]=i.useState([]),[l,f]=i.useState({total:0,unread:0,likes:0,comments:0,follows:0,events:0,messages:0}),[C,A]=i.useState(!1),[M,v]=i.useState(!0),b=i.useCallback((r=0)=>g(null,null,function*(){if(t){A(!0);try{const{data:e,error:a}=yield m.from("notifications").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).range(r*u,(r+1)*u-1);if(a)throw a;c(r===0?e||[]:o=>[...o,...e||[]]),v((e||[]).length===u)}catch(e){console.error("Error fetching notifications:",e),s({title:"Error",description:"Failed to load notifications",variant:"destructive"})}finally{A(!1)}}}),[t,u,s]),N=i.useCallback(()=>g(null,null,function*(){if(t)try{const{data:r,error:e}=yield m.from("notifications").select("type, read").eq("user_id",t.id);if(e)throw e;const a=(r||[]).reduce((o,E)=>{switch(o.total++,E.read||o.unread++,E.type){case"like":o.likes++;break;case"comment":o.comments++;break;case"follow":o.follows++;break;case"event":o.events++;break;case"message":o.messages++;break}return o},{total:0,unread:0,likes:0,comments:0,follows:0,events:0,messages:0});f(a)}catch(r){console.error("Error fetching notification counts:",r)}}),[t]),q=i.useCallback(r=>g(null,null,function*(){try{const{error:e}=yield m.from("notifications").update({read:!0}).eq("id",r);if(e)throw e;c(a=>a.map(o=>o.id===r?k(h({},o),{read:!0}):o)),f(a=>k(h({},a),{unread:Math.max(0,a.unread-1)}))}catch(e){console.error("Error marking notification as read:",e)}}),[]),x=i.useCallback(()=>g(null,null,function*(){if(t)try{const{error:r}=yield m.from("notifications").update({read:!0}).eq("user_id",t.id).eq("read",!1);if(r)throw r;c(e=>e.map(a=>k(h({},a),{read:!0}))),f(e=>k(h({},e),{unread:0})),s({title:"All caught up!",description:"All notifications marked as read"})}catch(r){console.error("Error marking all notifications as read:",r),s({title:"Error",description:"Failed to mark notifications as read",variant:"destructive"})}}),[t,s]),R=i.useCallback(r=>g(null,null,function*(){try{const{error:e}=yield m.from("notifications").delete().eq("id",r);if(e)throw e;c(a=>a.filter(o=>o.id!==r)),f(a=>k(h({},a),{total:Math.max(0,a.total-1),unread:Math.max(0,a.unread-1)}))}catch(e){console.error("Error deleting notification:",e)}}),[]),T=i.useCallback((r,e,a,o,E)=>g(null,null,function*(){try{const{error:p}=yield m.from("notifications").insert({user_id:r,type:e,title:a,message:o,data:E,read:!1});if(p)throw p}catch(p){console.error("Error creating notification:",p)}}),[]),F=i.useCallback(()=>{if(!C&&M){const r=Math.floor(d.length/u);b(r)}},[C,M,d.length,u,b]);return i.useEffect(()=>{if(!t||!y)return;const r=m.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${t.id}`},e=>{const a=e.new;c(o=>[a,...o]),f(o=>k(h({},o),{total:o.total+1,unread:o.unread+1})),a.type!=="system"&&s({title:a.title,description:a.message,duration:5e3})}).subscribe();return()=>{m.removeChannel(r)}},[t,y,s]),i.useEffect(()=>{if(w&&d.length>0){const r=d.filter(e=>!e.read);if(r.length>0){const e=setTimeout(()=>{r.forEach(a=>{q(a.id)})},3e3);return()=>clearTimeout(e)}}},[w,d,q]),i.useEffect(()=>{t&&(b(0),N())},[t,b,N]),{notifications:d,counts:l,isLoading:C,hasMore:M,loadMore:F,markAsRead:q,markAllAsRead:x,deleteNotification:R,createNotification:T,refetch:()=>{b(0),N()}}};export{K as u};
