var r=Object.defineProperty,t=Object.defineProperties,e=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,u=(t,e,o)=>e in t?r(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,c=(r,t)=>{for(var e in t||(t={}))i.call(t,e)&&u(r,e,t[e]);if(o)for(var e of o(t))n.call(t,e)&&u(r,e,t[e]);return r},s=(r,o)=>t(r,e(o)),a=(r,t,e)=>new Promise((o,i)=>{var n=r=>{try{c(e.next(r))}catch(t){i(t)}},u=r=>{try{c(e.throw(r))}catch(t){i(t)}},c=r=>r.done?o(r.value):Promise.resolve(r.value).then(n,u);c((e=e.apply(r,t)).next())});import{s as l}from"./index-BG6xRDTV.js";class d{static ensureAuthenticated(){return a(this,null,function*(){try{const{data:{user:r},error:t}=yield l.auth.getUser();if(t)throw new Error("Authentication error");if(!r)throw new Error("User not authenticated");return r}catch(r){throw new Error("User not authenticated")}})}static retryOperation(r,t=3,e=1e3){return a(this,null,function*(){let o;for(let n=1;n<=t;n++)try{return yield r()}catch(i){o=i,n<t&&(yield new Promise(r=>setTimeout(r,e*n)))}throw o})}static createGroup(r){return a(this,null,function*(){try{const t=yield this.ensureAuthenticated(),{data:e,error:o}=yield l.from("community_groups").insert(s(c({},r),{created_by:t.id})).select().single();if(o)throw o;return yield this.addGroupMember(e.id,t.id,"admin"),e}catch(t){return null}})}static getGroups(r){return a(this,null,function*(){try{let t=l.from("community_groups").select("*").order("created_at",{ascending:!1});(null==r?void 0:r.category)&&(t=t.eq("category",r.category)),void 0!==(null==r?void 0:r.is_public)&&(t=t.eq("is_public",r.is_public)),(null==r?void 0:r.location_city)&&(t=t.eq("location_city",r.location_city)),(null==r?void 0:r.member_count_min)&&(t=t.gte("member_count",r.member_count_min));const{data:e,error:o}=yield t;if(o)throw o;if(!e||0===e.length){yield this.createSampleGroups();const{data:r,error:e}=yield t;if(e)throw e;return r||[]}return e||[]}catch(t){return[]}})}static createSampleGroups(){return a(this,null,function*(){try{const{data:{user:r}}=yield l.auth.getUser(),t=(null==r?void 0:r.id)||"00000000-0000-0000-0000-000000000000",e=[{name:"Local Artists Network",description:"Connect with local artists and share your work",category:"Arts & Culture",created_by:t,location_city:"New York",location_state:"NY",location_country:"USA",is_public:!0,member_count:0,post_count:0},{name:"Tech Enthusiasts",description:"Discuss the latest in technology and innovation",category:"Technology",created_by:t,location_city:"San Francisco",location_state:"CA",location_country:"USA",is_public:!0,member_count:0,post_count:0},{name:"Food Lovers",description:"Share recipes and discover local restaurants",category:"Food & Dining",created_by:t,location_city:"Chicago",location_state:"IL",location_country:"USA",is_public:!0,member_count:0,post_count:0}];for(const o of e){const{error:r}=yield l.from("community_groups").insert(o);r&&r.code}}catch(r){}})}static getGroupById(r){return a(this,null,function*(){try{const{data:t,error:e}=yield l.from("community_groups").select("*").eq("id",r).single();if(e)throw e;return t}catch(t){return null}})}static updateGroup(r,t){return a(this,null,function*(){try{const{error:e}=yield l.from("community_groups").update(t).eq("id",r);if(e)throw e;return!0}catch(e){return!1}})}static deleteGroup(r){return a(this,null,function*(){try{const{error:t}=yield l.from("community_groups").delete().eq("id",r);if(t)throw t;return!0}catch(t){return!1}})}static addGroupMember(r,t,e="member"){return a(this,null,function*(){return this.retryOperation(()=>a(this,null,function*(){try{yield this.ensureAuthenticated();const o=yield this.getGroupById(r);if(!o)throw new Error("Group not found");if(!o.is_public)throw new Error("Cannot join private group");if(yield this.isGroupMember(r,t))return!0;const{data:i,error:n}=yield l.from("auth.users").select("id").eq("id",t).single(),{error:u}=yield l.from("group_members").insert({group_id:r,user_id:t,role:e});if(u){if("23505"===u.code)return!0;if("23503"===u.code){const{data:e}=yield l.from("community_groups").select("id, name").eq("id",r),{data:o}=yield l.from("auth.users").select("id").eq("id",t);throw new Error("Invalid group or user ID")}throw u}return yield this.updateGroupMemberCount(r),!0}catch(o){throw o}}))})}static removeGroupMember(r,t){return a(this,null,function*(){return this.retryOperation(()=>a(this,null,function*(){try{yield this.ensureAuthenticated();const{error:e}=yield l.from("group_members").delete().eq("group_id",r).eq("user_id",t);if(e)throw e;return yield this.updateGroupMemberCount(r),!0}catch(e){throw e}}))})}static getGroupMembers(r){return a(this,null,function*(){try{const{data:t,error:e}=yield l.from("group_members").select("\n          *,\n          profiles:user_id (\n            display_name,\n            avatar_url\n          )\n        ").eq("group_id",r).order("joined_at",{ascending:!0});if(e)throw e;return(t||[]).map(r=>{var t,e;return s(c({},r),{user_name:null==(t=r.profiles)?void 0:t.display_name,user_avatar:null==(e=r.profiles)?void 0:e.avatar_url})})}catch(t){return[]}})}static getUserGroups(r){return a(this,null,function*(){return this.retryOperation(()=>a(this,null,function*(){try{yield this.ensureAuthenticated();const{data:t,error:e}=yield l.from("group_members").select("\n            community_groups (*)\n          ").eq("user_id",r);if(e)throw e;return(t||[]).map(r=>r.community_groups)}catch(t){throw t}}))})}static isGroupMember(r,t){return a(this,null,function*(){try{const{data:e,error:o}=yield l.from("group_members").select("id").eq("group_id",r).eq("user_id",t).single();if(o&&"PGRST116"!==o.code)throw o;return!!e}catch(e){return!1}})}static getUserRole(r,t){return a(this,null,function*(){try{const{data:e,error:o}=yield l.from("group_members").select("role").eq("group_id",r).eq("user_id",t).single();if(o&&"PGRST116"!==o.code)throw o;return(null==e?void 0:e.role)||null}catch(e){return null}})}static updateGroupMemberCount(r){return a(this,null,function*(){try{const{count:t,error:e}=yield l.from("group_members").select("*",{count:"exact",head:!0}).eq("group_id",r);if(e)throw e;yield l.from("community_groups").update({member_count:t||0}).eq("id",r)}catch(t){}})}static validateGroupForJoining(r,t){return a(this,null,function*(){const e=[];try{const o=yield this.getGroupById(r);o?o.is_public||e.push("Group is not public"):e.push("Group does not exist");const{data:{user:i},error:n}=yield l.auth.getUser();if(n||!i?e.push("User not authenticated"):i.id!==t&&e.push("User ID mismatch"),o&&i){(yield this.isGroupMember(r,t))&&e.push("User is already a member")}return{isValid:0===e.length,group:o,user:i,errors:e}}catch(o){return e.push(`Validation error: ${o}`),{isValid:!1,errors:e}}})}static debugGroupIssues(){return a(this,null,function*(){try{const{data:r,error:t}=yield l.from("community_groups").select("id, name, is_public, created_at, created_by").limit(10),{data:e,error:o}=yield l.from("group_members").select("id, group_id, user_id, role").limit(10),{data:{user:i},error:n}=yield l.auth.getUser(),{data:u,error:c}=yield l.from("group_members").select("group_id, user_id").not("group_id","in",`(${(null==r?void 0:r.map(r=>`'${r.id}'`).join(","))||""})`),{data:s,error:a}=yield l.rpc("get_rls_policies",{table_name:"group_members"}).catch(()=>({data:null,error:"RPC not available"}));return{groups:r||[],members:e||[],orphanedMembers:u||[],currentUser:i,errors:{groups:t,members:o,user:n,orphaned:c,rls:a},summary:{totalGroups:(null==r?void 0:r.length)||0,totalMembers:(null==e?void 0:e.length)||0,orphanedMembers:(null==u?void 0:u.length)||0,userAuthenticated:!!i}}}catch(r){return{error:r}}})}static searchGroups(r,t){return a(this,null,function*(){try{let e=l.from("community_groups").select("*").or(`name.ilike.%${r}%,description.ilike.%${r}%`).eq("is_public",!0).order("member_count",{ascending:!1});(null==t?void 0:t.category)&&(e=e.eq("category",t.category)),(null==t?void 0:t.location_city)&&(e=e.eq("location_city",t.location_city));const{data:o,error:i}=yield e;if(i)throw i;return o||[]}catch(e){return[]}})}static getTrendingGroups(r=10){return a(this,null,function*(){try{const{data:t,error:e}=yield l.from("community_groups").select("*").eq("is_public",!0).order("member_count",{ascending:!1}).order("post_count",{ascending:!1}).limit(r);if(e)throw e;return t||[]}catch(t){return[]}})}static getGroupsByCategory(r){return a(this,null,function*(){try{const{data:t,error:e}=yield l.from("community_groups").select("*").eq("category",r).eq("is_public",!0).order("member_count",{ascending:!1});if(e)throw e;return t||[]}catch(t){return[]}})}static getGroupsByLocation(r){return a(this,null,function*(){try{let t=l.from("community_groups").select("*").eq("is_public",!0);r.city&&(t=t.eq("location_city",r.city)),r.state&&(t=t.eq("location_state",r.state)),r.country&&(t=t.eq("location_country",r.country));const{data:e,error:o}=yield t.order("member_count",{ascending:!1});if(o)throw o;return e||[]}catch(t){return[]}})}}export{d as C};
