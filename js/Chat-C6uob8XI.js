var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,o=(e,s,t)=>new Promise((r,i)=>{var a=e=>{try{o(t.next(e))}catch(s){i(s)}},n=e=>{try{o(t.throw(e))}catch(s){i(s)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,n);o((t=t.apply(e,s)).next())});import{u as l,d,r as c,s as m,j as u,C as p,y as j,B as h,X as v,U as x,b as f,v as g,w as y}from"./main-6fHUpRzT.js";import{n as b}from"./useNotifications-DlOFbLc9.js";import{R as _}from"./ResponsiveLayout-Bc2JEU4o.js";import{A as N,a as w,b as S}from"./sheet-D2smYKYW.js";import{T as O}from"./textarea-DdxXr3wS.js";import{S as P}from"./send-CK2vf9xp.js";import{A as E}from"./arrow-left-CQA9bfHi.js";import{f as M}from"./index-GQUAIkZv.js";import"./index-BlbmBgSN.js";import"./Combination-Bb2n9b59.js";import"./tabs-BNobDGc4.js";import"./check-BVB7WkBF.js";import"./input-C0XSs2D-.js";import"./separator-55ip2E4B.js";import"./NotificationBell-C-odGad4.js";import"./badge-Bj-CyBpD.js";import"./scroll-area-DRpKKhsW.js";import"./index-jVOyRz7F.js";import"./bell-DFXHEubE.js";import"./user-DoINJrqZ.js";import"./NotificationButton-CnmvsVP-.js";import"./search-CeL_nYcN.js";import"./map-pin-DJOBTPKn.js";import"./index-YNlOS8aM.js";import"./users-Czby48qY.js";import"./zap-Dyj-3m1T.js";import"./message-square-BNIlY-fX.js";import"./alert-BCcU8rrr.js";import"./wifi-D7M5OVnX.js";import"./log-out-B3lkkfQi.js";const C=e=>{const{user:u}=l(),{toast:p}=d(),[j,h]=c.useState(null),[v,x]=c.useState([]),[f,g]=c.useState(!0),y=c.useRef(null);c.useEffect(()=>{if(!e||!u)return;g(!0),_(),N();const s=m.channel(`chat_messages_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`conversation_id=eq.${e}`},e=>{x(s=>[...s,e.new])}).subscribe();return y.current=s,()=>{y.current&&m.removeChannel(y.current)}},[e,null==u?void 0:u.id]);const _=()=>o(void 0,null,function*(){try{const{data:o,error:l}=yield m.from("chat_conversations").select("*").eq("id",e).single();if(l)throw l;const d=o.client_id===(null==u?void 0:u.id)?o.artist_id:o.client_id,{data:c}=yield m.from("profiles").select("user_id, display_name, avatar_url").eq("user_id",d).single();h(((e,r)=>s(e,t(r)))(((e,s)=>{for(var t in s||(s={}))i.call(s,t)&&n(e,t,s[t]);if(r)for(var t of r(s))a.call(s,t)&&n(e,t,s[t]);return e})({},o),{other_user:c||void 0}))}catch(o){p({title:"Error",description:o instanceof Error?o.message:"Failed to load conversation",variant:"destructive"})}finally{g(!1)}}),N=()=>o(void 0,null,function*(){try{const{data:s,error:t}=yield m.from("chat_messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(t)throw t;x(s||[])}catch(s){p({title:"Error",description:s instanceof Error?s.message:"Failed to load messages",variant:"destructive"})}}),w=c.useMemo(()=>e=>e===(null==u?void 0:u.id),[null==u?void 0:u.id]);return{loading:f,conversation:j,messages:v,sendMessage:s=>o(void 0,null,function*(){if(!u||!e)return;const{error:t}=yield m.from("chat_messages").insert({conversation_id:e,sender_id:u.id,message:s,message_type:"text"});if(t)throw t;if("pending"===(null==j?void 0:j.status)){const s=u.id===(null==j?void 0:j.client_id)?null==j?void 0:j.artist_id:null==j?void 0:j.client_id;if(s)try{yield b.createMessageRequestNotification(u.id,s,e)}catch(r){}}}),isOwnMessage:w}},R=({onSubmit:e,placeholder:s="Type your message...",parentMessage:t,onCancelReply:r,initialValue:i="",submitLabel:a="Send"})=>{const[n,l]=c.useState(i),[d,m]=c.useState(!1),x=s=>o(void 0,null,function*(){if(s.preventDefault(),n.trim()&&!d){m(!0);try{yield e(n.trim()),l(""),null==r||r()}catch(t){}finally{m(!1)}}});return u.jsx(p,{className:"shadow-sm",children:u.jsxs(j,{className:"p-4",children:[t&&u.jsxs("div",{className:"mb-3 p-3 bg-muted rounded-lg text-sm",children:[u.jsxs("div",{className:"flex items-center justify-between mb-1",children:[u.jsxs("span",{className:"font-medium text-muted-foreground",children:["Replying to ",t.user_display_name]}),u.jsx(h,{variant:"ghost",size:"sm",onClick:r,className:"h-6 w-6 p-0",children:u.jsx(v,{className:"h-4 w-4"})})]}),u.jsx("p",{className:"text-muted-foreground line-clamp-2",children:t.content})]}),u.jsxs("form",{onSubmit:x,className:"space-y-3",children:[u.jsx(O,{value:n,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x(e))},placeholder:s,className:"min-h-[80px] resize-none",disabled:d}),u.jsxs("div",{className:"flex justify-between items-center",children:[u.jsx("span",{className:"text-xs text-muted-foreground",children:"Press Enter to send, Shift+Enter for new line"}),u.jsxs(h,{type:"submit",disabled:!n.trim()||d,className:"flex items-center gap-2",children:[u.jsx(P,{className:"h-4 w-4"}),a]})]})]})]})})},k=()=>{var e,s,t,r;const{conversationId:i}=x(),a=f(),{loading:n,conversation:o,messages:l,sendMessage:d,isOwnMessage:c}=C(i);return u.jsx(_,{children:u.jsxs("div",{className:"max-w-4xl mx-auto space-y-4",children:[u.jsx("div",{className:"flex items-center gap-3",children:u.jsxs(h,{variant:"outline",size:"sm",onClick:()=>a(-1),children:[u.jsx(E,{className:"h-4 w-4 mr-1"})," Back"]})}),u.jsxs(p,{children:[u.jsx(g,{className:"flex flex-row items-center justify-between",children:u.jsxs("div",{className:"flex items-center gap-3",children:[u.jsxs(N,{children:[u.jsx(w,{src:null==(e=null==o?void 0:o.other_user)?void 0:e.avatar_url}),u.jsx(S,{children:(null==(t=null==(s=null==o?void 0:o.other_user)?void 0:s.display_name)?void 0:t.charAt(0))||"U"})]}),u.jsxs("div",{children:[u.jsx(y,{className:"text-lg",children:(null==(r=null==o?void 0:o.other_user)?void 0:r.display_name)||"Conversation"}),u.jsxs("p",{className:"text-sm text-muted-foreground",children:["Started ",(null==o?void 0:o.created_at)?M(new Date(o.created_at),"PPp"):""]})]})]})}),u.jsxs(j,{children:[u.jsx("div",{className:"h-[50vh] overflow-y-auto space-y-3 p-2 bg-muted/30 rounded-md",children:n?u.jsx("div",{className:"flex items-center justify-center h-full",children:u.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):l.map(e=>u.jsx("div",{className:"flex "+(c(e.sender_id)?"justify-end":"justify-start"),children:u.jsxs("div",{className:"max-w-[70%] rounded-lg px-3 py-2 text-sm "+(c(e.sender_id)?"bg-primary text-primary-foreground":"bg-card border"),children:[u.jsx("div",{className:"whitespace-pre-wrap",children:e.message}),u.jsx("div",{className:"mt-1 text-[10px] "+(c(e.sender_id)?"text-primary-foreground/70":"text-muted-foreground"),children:M(new Date(e.created_at),"PPp")})]})},e.id))}),"active"===(null==o?void 0:o.status)||"pending"===(null==o?void 0:o.status)?u.jsx("div",{className:"mt-4",children:u.jsx(R,{onSubmit:d,placeholder:"Send a message..."})}):u.jsx("div",{className:"mt-4 text-sm text-muted-foreground",children:"pending"===(null==o?void 0:o.status)?u.jsxs("div",{children:["This conversation is pending. Go to Messages to accept or decline.",u.jsx(h,{variant:"outline",size:"sm",className:"ml-2",onClick:()=>a("/messages"),children:"Open Messages"})]}):u.jsx("div",{children:"This conversation is closed."})})]})]})]})})};export{k as default};
