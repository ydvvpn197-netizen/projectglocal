var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,o=(e,s,t)=>new Promise((r,i)=>{var a=e=>{try{o(t.next(e))}catch(s){i(s)}},n=e=>{try{o(t.throw(e))}catch(s){i(s)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,n);o((t=t.apply(e,s)).next())});import{u as l,d as c,b as d,r as m,s as u,j as p,B as j}from"./index-B5IYdG7F.js";import{R as x}from"./ResponsiveLayout-BzUw0buI.js";import{C as h,d as v}from"./card-Bm1jiGt-.js";import{T as f,a as _,b as y,c as b}from"./tabs-DPPBWbFC.js";import{A as N,a as g,b as w}from"./sheet-CgDUfSpi.js";import{B as q}from"./badge-Dh5Uj8vN.js";import{M as O}from"./message-circle-CZlRU4gv.js";import{f as P}from"./index-DWtoKlrM.js";import"./input-C4_QhDnm.js";import"./separator-BZYZTYLW.js";import"./NotificationBell-DtnEojo4.js";import"./Combination-BxRIZ8rt.js";import"./scroll-area-Beiyt5Kx.js";import"./index-9msbY5CZ.js";import"./index-jVOyRz7F.js";import"./useNotifications-C0wifgqF.js";import"./check-C9wwFfOs.js";import"./bell-qeMkXRtc.js";import"./settings-DSEWn2wM.js";import"./user-UOowhO7W.js";import"./NotificationButton-CqXjP_LK.js";import"./search-Co_OHmlK.js";import"./map-pin-BwnggLrZ.js";import"./index-DD_J5sPn.js";import"./users-Dh-Bdb-k.js";import"./zap-DPSXpNso.js";import"./message-square-j4RxGxzk.js";import"./alert-CQybxmNr.js";import"./log-out-DchhrZ8K.js";const S=()=>{const{user:e}=l(),{toast:S}=c(),R=d(),[k,C]=m.useState(!0),[D,A]=m.useState([]),[B,E]=m.useState([]);m.useEffect(()=>{e&&U()},[null==e?void 0:e.id]);const U=()=>o(void 0,null,function*(){if(e){C(!0);try{const{data:o,error:l}=yield u.from("chat_conversations").select("*").or(`client_id.eq.${e.id},artist_id.eq.${e.id}`).order("updated_at",{ascending:!1});if(l)throw l;const c=o||[],d=c.map(s=>s.client_id===e.id?s.artist_id:s.client_id),{data:m}=yield u.from("profiles").select("user_id, display_name, avatar_url").in("user_id",d),p=new Map((m||[]).map(e=>[e.user_id,e])),j=c.map(o=>((e,r)=>s(e,t(r)))(((e,s)=>{for(var t in s||(s={}))i.call(s,t)&&n(e,t,s[t]);if(r)for(var t of r(s))a.call(s,t)&&n(e,t,s[t]);return e})({},o),{other_user:p.get(o.client_id===e.id?o.artist_id:o.client_id)}));A(j.filter(e=>"active"===e.status)),E(j.filter(s=>"pending"===s.status&&s.client_id!==e.id))}catch(o){S({title:"Error",description:o.message||"Failed to load messages",variant:"destructive"})}finally{C(!1)}}});return p.jsx(x,{children:p.jsxs("div",{className:"container max-w-4xl mx-auto p-6",children:[p.jsxs("div",{className:"mb-6",children:[p.jsx("h1",{className:"text-2xl font-bold",children:"Messages"}),p.jsx("p",{className:"text-muted-foreground",children:"Chat with your connections. Requests must be accepted before chatting."})]}),p.jsxs(f,{defaultValue:"active",children:[p.jsxs(_,{children:[p.jsx(y,{value:"active",children:"Active"}),p.jsx(y,{value:"requests",children:"Requests"})]}),p.jsx(b,{value:"active",className:"mt-4",children:k?p.jsx("div",{className:"flex items-center justify-center py-12",children:p.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):0===D.length?p.jsx(h,{children:p.jsxs(v,{className:"text-center py-12 text-muted-foreground",children:[p.jsx(O,{className:"h-10 w-10 mx-auto mb-2"}),"No active conversations"]})}):p.jsx("div",{className:"space-y-3",children:D.map(e=>{var s,t,r,i;return p.jsx(h,{className:"cursor-pointer hover:shadow-md",onClick:()=>R(`/chat/${e.id}`),children:p.jsxs(v,{className:"p-4 flex items-center gap-3",children:[p.jsxs(N,{children:[p.jsx(g,{src:null==(s=e.other_user)?void 0:s.avatar_url}),p.jsx(w,{children:(null==(r=null==(t=e.other_user)?void 0:t.display_name)?void 0:r.charAt(0))||"U"})]}),p.jsxs("div",{className:"flex-1",children:[p.jsxs("div",{className:"flex items-center gap-2",children:[p.jsx("span",{className:"font-medium",children:(null==(i=e.other_user)?void 0:i.display_name)||"User"}),e.booking_id&&p.jsx(q,{variant:"secondary",children:"Booking"})]}),p.jsxs("div",{className:"text-xs text-muted-foreground",children:["Started ",P(new Date(e.created_at),"PPp")]})]}),p.jsx(j,{variant:"outline",size:"sm",children:"Open"})]})},e.id)})})}),p.jsx(b,{value:"requests",className:"mt-4",children:k?p.jsx("div",{className:"flex items-center justify-center py-12",children:p.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):0===B.length?p.jsx(h,{children:p.jsxs(v,{className:"text-center py-12 text-muted-foreground",children:[p.jsx(O,{className:"h-10 w-10 mx-auto mb-2"}),"No pending requests"]})}):p.jsx("div",{className:"space-y-3",children:B.map(e=>{var s,t,r,i;return p.jsx(h,{children:p.jsxs(v,{className:"p-4 flex items-center gap-3",children:[p.jsxs(N,{children:[p.jsx(g,{src:null==(s=e.other_user)?void 0:s.avatar_url}),p.jsx(w,{children:(null==(r=null==(t=e.other_user)?void 0:t.display_name)?void 0:r.charAt(0))||"U"})]}),p.jsxs("div",{className:"flex-1",children:[p.jsx("div",{className:"font-medium",children:(null==(i=e.other_user)?void 0:i.display_name)||"User"}),p.jsxs("div",{className:"text-xs text-muted-foreground",children:["Requested ",P(new Date(e.created_at),"PPp")]})]}),p.jsxs("div",{className:"flex gap-2",children:[p.jsx(j,{size:"sm",onClick:()=>(e=>o(void 0,null,function*(){const{error:s}=yield u.from("chat_conversations").update({status:"active",updated_at:(new Date).toISOString()}).eq("id",e);s?S({title:"Error",description:"Failed to accept request",variant:"destructive"}):(U(),S({title:"Request accepted"}))}))(e.id),children:"Accept"}),p.jsx(j,{size:"sm",variant:"outline",onClick:()=>(e=>o(void 0,null,function*(){const{error:s}=yield u.from("chat_conversations").update({status:"closed",updated_at:(new Date).toISOString()}).eq("id",e);s?S({title:"Error",description:"Failed to decline request",variant:"destructive"}):(U(),S({title:"Request declined"}))}))(e.id),children:"Decline"})]})]})},e.id)})})})]})]})})};export{S as default};
