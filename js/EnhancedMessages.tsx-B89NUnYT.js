var b=(q,a,n)=>new Promise((j,v)=>{var h=i=>{try{f(n.next(i))}catch(c){v(c)}},E=i=>{try{f(n.throw(i))}catch(c){v(c)}},f=i=>i.done?j(i.value):Promise.resolve(i.value).then(h,E);f((n=n.apply(q,a)).next())});import{r as m,j as e}from"./chunk-V8Tq47hD.js";import{ResponsiveLayout as S}from"./ResponsiveLayout.tsx-CBMj4ano.js";import{u as Q,e as V,C as g,a as p,B as _}from"./main-nj8_qmr1.js";import{B as N}from"./chunk-BqqQDpKD.js";import{A as T,a as R,b as F}from"./chunk-CJL1E-Mt.js";import{I as Y}from"./chunk-CfjvP89K.js";import{T as W,a as $,b as y,c as G}from"./chunk-Dqojk3_S.js";import{C}from"./chunk-DG7cS-OT.js";import{p as J}from"./chunk-aOfXXddH.js";import{x as K,S as O,v as X,h as L,p as M,af as U,ag as Z}from"./chunk-BD2ShIYc.js";import{a as k}from"./chunk-jOF7Mqj2.js";import"./chunk-7Gxbu0Lx.js";import"./chunk-BbVfpXIH.js";import"./chunk-HDUI5Ctd.js";import"./chunk-DkszvQuI.js";import"./chunk-Cv5hKDJv.js";const pe=()=>{const q=J(),{user:a}=Q(),{toast:n}=V(),[j,v]=m.useState([]),[h,E]=m.useState([]),[f,i]=m.useState(!0),[c,P]=m.useState(""),[x,B]=m.useState("all"),w=m.useCallback(()=>b(null,null,function*(){if(a){i(!0);try{const[s,t]=yield Promise.all([C.getUserConversations(a.id),C.getPendingRequests(a.id)]);v(s),E(t)}catch(s){console.error("Error loading conversations:",s),n({title:"Error",description:"Failed to load conversations",variant:"destructive"})}finally{i(!1)}}}),[a,n]);m.useEffect(()=>{a&&w()},[a,w]);const I=s=>b(null,null,function*(){try{if(yield C.acceptConversation(s,a.id))n({title:"Request Accepted",description:"You can now chat with this user"}),w();else throw new Error("Failed to accept request")}catch(t){console.error("Error accepting request:",t),n({title:"Error",description:"Failed to accept request",variant:"destructive"})}}),z=s=>b(null,null,function*(){try{if(yield C.blockConversation(s,a.id))n({title:"Request Blocked",description:"This conversation has been blocked"}),w();else throw new Error("Failed to block request")}catch(t){console.error("Error blocking request:",t),n({title:"Error",description:"Failed to block request",variant:"destructive"})}}),H=s=>{if(!s)return"";try{const t=new Date(s),r=(new Date().getTime()-t.getTime())/(1e3*60*60);return r<1?k(t,"HH:mm"):r<24?k(t,"HH:mm"):r<168?k(t,"EEE"):k(t,"MMM dd")}catch(t){return""}},D=s=>{if(s.status==="pending")return e.jsx(M,{className:"w-4 h-4 text-orange-500"});if(s.last_message){if(s.last_message.sender_id===(a==null?void 0:a.id))return s.last_message.is_read?e.jsx(Z,{className:"w-4 h-4 text-blue-500"}):e.jsx(U,{className:"w-4 h-4 text-muted-foreground"});if(s.unread_count&&s.unread_count>0)return e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"})}return null},A=j.filter(s=>x==="unread"?s.unread_count&&s.unread_count>0:x==="pending"?s.status==="pending":x==="active"?s.status==="active":!0).filter(s=>{var l,r,d,o,u;if(!c)return!0;const t=c.toLowerCase();return((r=(l=s.other_user)==null?void 0:l.display_name)==null?void 0:r.toLowerCase().includes(t))||((o=(d=s.other_user)==null?void 0:d.username)==null?void 0:o.toLowerCase().includes(t))||((u=s.last_message)==null?void 0:u.message.toLowerCase().includes(t))});return f?e.jsx(S,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Messages"})}),e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx(g,{children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"animate-pulse flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-muted rounded-full"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-muted rounded w-1/2"})]})]})})},t))})]})}):e.jsx(S,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Messages"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_,{variant:"outline",size:"sm",children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Filter"]}),e.jsxs(_,{variant:"outline",size:"sm",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"Settings"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(X,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(Y,{placeholder:"Search conversations...",value:c,onChange:s=>P(s.target.value),className:"pl-10"})]}),e.jsxs(W,{value:x,onValueChange:B,children:[e.jsxs($,{className:"grid w-full grid-cols-4",children:[e.jsx(y,{value:"all",children:"All"}),e.jsxs(y,{value:"unread",children:["Unread",j.some(s=>s.unread_count&&s.unread_count>0)&&e.jsx(N,{variant:"destructive",className:"ml-2 h-5 w-5 p-0 text-xs",children:j.filter(s=>s.unread_count&&s.unread_count>0).length})]}),e.jsxs(y,{value:"pending",children:["Pending",h.length>0&&e.jsx(N,{variant:"destructive",className:"ml-2 h-5 w-5 p-0 text-xs",children:h.length})]}),e.jsx(y,{value:"active",children:"Active"})]}),e.jsx(G,{value:x,className:"space-y-4",children:x==="pending"?e.jsx("div",{className:"space-y-4",children:h.length===0?e.jsx(g,{children:e.jsxs(p,{className:"p-8 text-center",children:[e.jsx(L,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Pending Requests"}),e.jsx("p",{className:"text-muted-foreground",children:"You don't have any pending conversation requests"})]})}):h.map(s=>{var t,l,r,d,o,u;return e.jsx(g,{className:"border-orange-200",children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(T,{className:"w-12 h-12",children:[e.jsx(R,{src:((t=s.other_user)==null?void 0:t.avatar_url)||void 0}),e.jsx(F,{children:((r=(l=s.other_user)==null?void 0:l.display_name)==null?void 0:r.charAt(0))||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:((d=s.other_user)==null?void 0:d.display_name)||"Unknown User"}),((o=s.other_user)==null?void 0:o.is_verified)&&e.jsx(N,{variant:"secondary",size:"sm",children:"Verified"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",((u=s.other_user)==null?void 0:u.username)||"anonymous"]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Wants to start a conversation with you"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",className:"text-orange-600 border-orange-600",children:"Pending"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(_,{size:"sm",onClick:()=>I(s.id),className:"h-8",children:[e.jsx(M,{className:"w-4 h-4 mr-1"}),"Accept"]}),e.jsx(_,{size:"sm",variant:"outline",onClick:()=>z(s.id),className:"h-8",children:"Block"})]})]})]})})},s.id)})}):e.jsx("div",{className:"space-y-4",children:A.length===0?e.jsx(g,{children:e.jsxs(p,{className:"p-8 text-center",children:[e.jsx(L,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Conversations"}),e.jsx("p",{className:"text-muted-foreground",children:c?"No conversations match your search":"Start a conversation with someone!"})]})}):A.map(s=>{var t,l,r,d,o,u;return e.jsx(g,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>q(`/chat/${s.id}`),children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(T,{className:"w-12 h-12",children:[e.jsx(R,{src:((t=s.other_user)==null?void 0:t.avatar_url)||void 0}),e.jsx(F,{children:((r=(l=s.other_user)==null?void 0:l.display_name)==null?void 0:r.charAt(0))||"U"})]}),((d=s.other_user)==null?void 0:d.is_verified)&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx(U,{className:"w-2 h-2 text-white"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold truncate",children:((o=s.other_user)==null?void 0:o.display_name)||"Unknown User"}),e.jsxs("div",{className:"flex items-center gap-2",children:[D(s),e.jsx("span",{className:"text-xs text-muted-foreground",children:H(s.last_message_at)})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:((u=s.last_message)==null?void 0:u.message)||"No messages yet"}),s.unread_count&&s.unread_count>0&&e.jsxs(N,{variant:"destructive",className:"mt-1 h-5 text-xs",children:[s.unread_count," unread"]})]})]})})},s.id)})})})]})]})})};export{pe as default};
