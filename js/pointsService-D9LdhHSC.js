var t=(t,r,e)=>new Promise((n,i)=>{var a=t=>{try{s(e.next(t))}catch(r){i(r)}},o=t=>{try{s(e.throw(t))}catch(r){i(r)}},s=t=>t.done?n(t.value):Promise.resolve(t.value).then(a,o);s((e=e.apply(t,r)).next())});import{s as r}from"./index-B5IYdG7F.js";class e{static getUserPoints(e){return t(this,null,function*(){try{const{data:t,error:n}=yield r.from("user_points").select("*").eq("user_id",e).single();if(n)throw n;return t}catch(t){return null}})}static addPoints(e,n,i,a,o){return t(this,null,function*(){try{const{data:t,error:s}=yield r.rpc("add_user_points",{p_user_id:e,p_points:n,p_transaction_type:i,p_description:a||"",p_metadata:o||null});if(s)throw s;return!0}catch(t){return!1}})}static getCurrentUserPoints(){return t(this,null,function*(){try{const{data:{user:t}}=yield r.auth.getUser();if(!t)throw new Error("User not authenticated");return yield this.getUserPoints(t.id)}catch(t){return null}})}static getLeaderboard(e){return t(this,null,function*(){try{let t=r.from("community_leaderboard").select("*").order("rank",{ascending:!0});(null==e?void 0:e.limit)&&(t=t.limit(e.limit)),(null==e?void 0:e.offset)&&(t=t.range(e.offset,e.offset+(e.limit||100)-1)),(null==e?void 0:e.min_points)&&(t=t.gte("total_points",e.min_points));const{data:n,error:i}=yield t;return i?yield this.getLeaderboardFallback(e):n||[]}catch(t){return yield this.getLeaderboardFallback(e)}})}static getLeaderboardFallback(e){return t(this,null,function*(){try{let t=r.from("user_points").select("\n          user_id,\n          total_points,\n          rank,\n          profiles:user_id (\n            display_name,\n            avatar_url\n          )\n        ").order("total_points",{ascending:!1});(null==e?void 0:e.limit)&&(t=t.limit(e.limit)),(null==e?void 0:e.offset)&&(t=t.range(e.offset,e.offset+(e.limit||100)-1)),(null==e?void 0:e.min_points)&&(t=t.gte("total_points",e.min_points));const{data:n,error:i}=yield t;if(i)throw i;return(n||[]).map(t=>{var r,e;return{id:t.user_id,user_id:t.user_id,display_name:null==(r=t.profiles)?void 0:r.display_name,avatar_url:null==(e=t.profiles)?void 0:e.avatar_url,total_points:t.total_points,rank:t.rank,last_updated:(new Date).toISOString()}})}catch(t){return[]}})}static getTopUsers(r=5){return t(this,null,function*(){return yield this.getLeaderboard({limit:r})})}static getPointHistory(e,n){return t(this,null,function*(){try{let t=r.from("point_transactions").select("*").eq("user_id",e).order("created_at",{ascending:!1});(null==n?void 0:n.transaction_type)&&(t=t.eq("transaction_type",n.transaction_type)),(null==n?void 0:n.date_from)&&(t=t.gte("created_at",n.date_from)),(null==n?void 0:n.date_to)&&(t=t.lte("created_at",n.date_to)),(null==n?void 0:n.limit)&&(t=t.limit(n.limit)),(null==n?void 0:n.offset)&&(t=t.range(n.offset,n.offset+(n.limit||100)-1));const{data:i,error:a}=yield t;if(a)throw a;return i||[]}catch(t){return[]}})}static getCurrentUserPointHistory(e){return t(this,null,function*(){try{const{data:{user:t}}=yield r.auth.getUser();if(!t)throw new Error("User not authenticated");return yield this.getPointHistory(t.id,e)}catch(t){return[]}})}static addPointsWithReference(e,n,i,a,o,s){return t(this,null,function*(){try{const{data:t,error:l}=yield r.rpc("add_user_points",{p_user_id:e,p_points:n,p_transaction_type:i,p_reference_id:a,p_reference_type:o,p_description:s});if(l)throw l;return t}catch(t){return!1}})}static handleEventAttendance(e,n){return t(this,null,function*(){try{const{data:t,error:i}=yield r.rpc("handle_event_points",{p_event_id:e,p_user_id:n,p_action:"attended"});if(i)throw i;return t}catch(t){return!1}})}static handleEventOrganization(e,n){return t(this,null,function*(){try{const{data:t,error:i}=yield r.rpc("handle_event_points",{p_event_id:e,p_user_id:n,p_action:"organized"});if(i)throw i;return t}catch(t){return!1}})}static handlePollCreation(e,n){return t(this,null,function*(){try{const{data:t,error:i}=yield r.rpc("handle_poll_points",{p_poll_id:e,p_user_id:n,p_action:"created"});if(i)throw i;return t}catch(t){return!1}})}static handlePostSharing(e,n){return t(this,null,function*(){try{const{data:t,error:i}=yield r.rpc("handle_share_points",{p_post_id:e,p_user_id:n});if(i)throw i;return t}catch(t){return!1}})}static getCurrentUserPointsSummary(){return t(this,null,function*(){try{const{data:{user:t}}=yield r.auth.getUser();if(!t)throw new Error("User not authenticated");const[e,n]=yield Promise.all([this.getUserPoints(t.id),this.getPointHistory(t.id,{limit:10})]);if(!e)return null;const i={};return n.forEach(t=>{const r=t.transaction_type;i[r]=(i[r]||0)+t.points}),{totalPoints:e.total_points,rank:e.rank,recentTransactions:n,pointsBreakdown:i}}catch(t){return null}})}static getLeaderboardWithUserPosition(r,e=100){return t(this,null,function*(){try{const[t,n]=yield Promise.all([this.getLeaderboard({limit:e}),this.getUserPoints(r)]),i=(null==n?void 0:n.rank)||0,a=t.find(t=>t.user_id===r);return{leaderboard:t,userPosition:i,userEntry:a}}catch(t){return{leaderboard:[],userPosition:0}}})}static refreshLeaderboardRanks(){return t(this,null,function*(){try{const{data:t,error:e}=yield r.rpc("refresh_all_leaderboard_ranks");if(e)throw e;return!0}catch(t){return!1}})}static getPointsStatistics(){return t(this,null,function*(){try{const[{count:t},{data:e},{data:n},{count:i}]=yield Promise.all([r.from("user_points").select("*",{count:"exact",head:!0}),r.from("user_points").select("total_points"),r.from("community_leaderboard").select("*").order("total_points",{ascending:!1}).limit(1).single(),r.from("point_transactions").select("*",{count:"exact",head:!0}).gte("created_at",new Date(Date.now()-864e5).toISOString())]),a=(null==e?void 0:e.reduce((t,r)=>t+r.total_points,0))||0;return{totalUsers:t||0,totalPoints:a,averagePoints:t?Math.round(a/t):0,topUser:n||null,recentActivity:i||0}}catch(t){return{totalUsers:0,totalPoints:0,averagePoints:0,topUser:null,recentActivity:0}}})}}export{e as P};
