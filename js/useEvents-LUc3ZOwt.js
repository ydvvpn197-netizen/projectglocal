var e=(e,t,n)=>new Promise((i,r)=>{var o=e=>{try{a(n.next(e))}catch(t){r(t)}},s=e=>{try{a(n.throw(e))}catch(t){r(t)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,s);a((n=n.apply(e,t)).next())});import{r as t,u as n,d as i,s as r}from"./main-6fHUpRzT.js";import{u as o}from"./useLocation-Bl6dvRZN.js";import{P as s}from"./pointsService-BOpHKILN.js";const a=()=>{const[a,l]=t.useState([]),[d,c]=t.useState(!0),{user:u}=n(),{toast:v}=i(),{currentLocation:g}=o(),f=t.useCallback(()=>e(void 0,null,function*(){var e,t,n,i,o,s,a,d;try{c(!0);const{data:e,error:t}=yield r.rpc("get_events_with_attendance");if(t)throw t;l(e||[])}catch(u){let r="Failed to fetch events";(null==(e=null==u?void 0:u.message)?void 0:e.includes("function"))&&(null==(t=null==u?void 0:u.message)?void 0:t.includes("does not exist"))?r="Database function not found. Please contact support.":"PGRST116"===(null==u?void 0:u.code)?r="Database function error. Please try again.":(null==(n=null==u?void 0:u.message)?void 0:n.includes("JWT"))?r="Authentication issue. Please try signing in again.":(null==(i=null==u?void 0:u.message)?void 0:i.includes("network"))||(null==(o=null==u?void 0:u.message)?void 0:o.includes("fetch"))||(null==(s=null==u?void 0:u.message)?void 0:s.includes("NetworkError"))?r="Network error. Please check your connection and try again.":"42883"===(null==u?void 0:u.code)?r="Database configuration error. Please contact support.":"42P01"===(null==u?void 0:u.code)?r="Database table not found. Please contact support.":(null==(a=null==u?void 0:u.message)?void 0:a.includes("404"))?r="Service endpoint not found. Please contact support.":(null==(d=null==u?void 0:u.message)?void 0:d.includes("500"))&&(r="Server error. Please try again in a few moments."),v({title:"Error",description:r,variant:"destructive"}),l([])}finally{c(!1)}}),[v,u]);t.useEffect(()=>{f()},[u,f]),t.useEffect(()=>{const e=r.channel("events-changes").on("postgres_changes",{event:"*",schema:"public",table:"events"},()=>{f()}).subscribe();return()=>{r.removeChannel(e)}},[f]);return{events:a,loading:d,createEvent:t=>e(void 0,null,function*(){if(!u)return v({title:"Error",description:"You must be logged in to create events",variant:"destructive"}),!1;try{const{error:e}=yield r.from("events").insert({user_id:u.id,title:t.title,description:t.description,event_date:t.event_date,event_time:t.event_time,location_name:t.location_name,location_city:void 0,location_state:void 0,location_country:void 0,latitude:null==g?void 0:g.latitude,longitude:null==g?void 0:g.longitude,category:t.category,max_attendees:t.max_attendees,price:t.price||0,image_url:t.image_url,tags:t.tags});if(e)throw e;const{data:n}=yield r.from("events").select("id").eq("user_id",u.id).eq("title",t.title).order("created_at",{ascending:!1}).limit(1).single();return n&&(yield s.handleEventOrganization(n.id,u.id)),v({title:"Success",description:"Event created successfully!"}),f(),!0}catch(e){return v({title:"Error",description:"Failed to create event",variant:"destructive"}),!1}}),toggleAttendance:t=>e(void 0,null,function*(){if(u)try{const e=a.find(e=>e.id===t);if(!e)return;if(e.user_attending){const{error:e}=yield r.from("event_attendees").delete().eq("event_id",t).eq("user_id",u.id);if(e)throw e;v({title:"Success",description:"You're no longer attending this event"})}else{const{error:e}=yield r.from("event_attendees").insert({event_id:t,user_id:u.id,status:"attending"});if(e)throw e;v({title:"Success",description:"You're now attending this event!"}),yield s.handleEventAttendance(t,u.id)}f()}catch(e){v({title:"Error",description:"Failed to update attendance",variant:"destructive"})}else v({title:"Error",description:"You must be logged in to attend events",variant:"destructive"})}),deleteEvent:t=>e(void 0,null,function*(){if(!u)return{error:new Error("Not authenticated")};try{const{error:e}=yield r.from("events").delete().eq("id",t).eq("user_id",u.id);if(e)throw e;return v({title:"Event deleted",description:"Your event has been deleted successfully."}),f(),{error:null}}catch(e){return v({title:"Error deleting event",description:e.message,variant:"destructive"}),{error:e}}}),refetch:f}};export{a as u};
