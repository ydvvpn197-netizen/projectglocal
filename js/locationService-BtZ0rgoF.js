var t=Object.defineProperty,e=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,c=(t,e)=>{for(var r in e||(e={}))o.call(e,r)&&a(t,r,e[r]);if(n)for(var r of n(e))i.call(e,r)&&a(t,r,e[r]);return t},s=(t,e,r)=>new Promise((n,o)=>{var i=t=>{try{c(r.next(t))}catch(e){o(e)}},a=t=>{try{c(r.throw(t))}catch(e){o(e)}},c=t=>t.done?n(t.value):Promise.resolve(t.value).then(i,a);c((r=r.apply(t,e)).next())});import{Z as l,s as u}from"./main-6fHUpRzT.js";import{c as d,d as f}from"./NotificationBell-C-odGad4.js";function h(t,e){return s(this,null,function*(){try{const r=yield function(t,e){return s(this,null,function*(){try{const r=l.apiKey;if(!r)throw new Error("Google Maps API key not configured");const n=yield fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${t},${e}&key=${r}`);if(!n.ok)throw new Error("Failed to fetch geocoding data");const o=yield n.json();if("OK"===o.status&&o.results.length>0)return o.results[0].formatted_address;throw new Error("No results found for coordinates")}catch(r){return`${t.toFixed(6)}, ${e.toFixed(6)}`}})}(t,e),n=r.split(",");return n.length>=2?n[1].trim():r}catch(r){return`${t.toFixed(4)}, ${e.toFixed(4)}`}})}function y(t,e,r=3e5){try{const n={data:e,timestamp:Date.now(),ttl:r};localStorage.setItem(`location_cache_${t}`,JSON.stringify(n))}catch(n){}}function _(){try{Object.keys(localStorage).forEach(t=>{t.startsWith("location_cache_")&&localStorage.removeItem(t)})}catch(t){}}class g{static checkUserPreferencesTable(){return s(this,null,function*(){if(null!==this.userPreferencesTableAvailable)return this.userPreferencesTableAvailable;try{const t=yield d("user_preferences");return this.userPreferencesTableAvailable=t.exists,this.userPreferencesTableAvailable,this.userPreferencesTableAvailable}catch(t){return this.userPreferencesTableAvailable=!1,!1}})}static getCurrentUserLocation(){return s(this,null,function*(){try{const{data:{user:t}}=yield u.auth.getUser();if(!t)return null;const e=function(t){try{const e=localStorage.getItem(`location_cache_${t}`);if(!e)return null;const r=JSON.parse(e);return Date.now()-r.timestamp>r.ttl?(localStorage.removeItem(`location_cache_${t}`),null):r.data}catch(e){return null}}(`user_${t.id}`);if(e)return e;const{data:r}=yield u.from("profiles").select("latitude, longitude, real_time_location_enabled, location_city, location_state, location_country").eq("user_id",t.id).single();if(r&&r.latitude&&r.longitude){const e={lat:r.latitude,lng:r.longitude,name:r.location_city?`${r.location_city}, ${r.location_state||""}`.trim():void 0};return y(`user_${t.id}`,e),e}return null}catch(t){return null}})}static getUserLocationPreferences(){return s(this,null,function*(){try{if(!(yield this.checkUserPreferencesTable()))return f();const{data:{user:t}}=yield u.auth.getUser();if(!t)return f();const{data:e,error:r}=yield u.from("user_preferences").select("*").eq("user_id",t.id).single();if(r&&"PGRST116"!==r.code)return f();if(!e){const t=f();return yield this.saveUserLocationPreferences(t),t}return c(c({},f()),e)}catch(t){return f()}})}static saveUserLocationPreferences(t){return s(this,null,function*(){try{if(!(yield this.checkUserPreferencesTable()))return!1;const{data:{user:n}}=yield u.auth.getUser();if(!n)throw new Error("User not authenticated");const{error:o}=yield u.from("user_preferences").upsert(((t,n)=>e(t,r(n)))(c({user_id:n.id},t),{updated_at:(new Date).toISOString()}),{onConflict:"user_id"});if(o)throw o;return!0}catch(n){return!1}})}static detectAndSaveLocation(){return s(this,null,function*(){try{const{data:{user:t}}=yield u.auth.getUser();if(!t)throw new Error("User not authenticated");const e=yield function(){return new Promise((t,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{const r={lat:e.coords.latitude,lng:e.coords.longitude};t(r)},t=>{e(new Error(`Geolocation error: ${t.message}`))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):e(new Error("Geolocation is not supported by this browser"))})}(),r=yield h(e.lat,e.lng);e.name=r;const{error:n}=yield u.rpc("update_user_location",{user_uuid:t.id,lat:e.lat,lng:e.lng,location_name:r});if(n)throw n;return y(`user_${t.id}`,e),e}catch(t){return null}})}static setManualLocation(t){return s(this,null,function*(){try{const{data:{user:e}}=yield u.auth.getUser();if(!e)throw new Error("User not authenticated");const{error:r}=yield u.rpc("update_user_location",{user_uuid:e.id,lat:t.lat,lng:t.lng,location_name:t.name||null});if(r)throw r;y(`user_${e.id}`,t)}catch(e){throw e}})}static getUserPreferences(){return s(this,null,function*(){try{const{data:{user:t}}=yield u.auth.getUser();if(!t)return null;const{data:e,error:r}=yield u.from("user_preferences").select("*").eq("user_id",t.id).single();if(r&&"PGRST116"!==r.code)throw r;return e}catch(t){return null}})}static updateUserPreferences(t){return s(this,null,function*(){try{const{data:{user:e}}=yield u.auth.getUser();if(!e)throw new Error("User not authenticated");const{error:r}=yield u.from("user_preferences").upsert(c({user_id:e.id},t));if(r)throw r}catch(e){throw e}})}static getLocationSettings(){return s(this,null,function*(){var t,e;try{const{data:{user:r}}=yield u.auth.getUser();if(!r)throw new Error("User not authenticated");const[n,o]=yield Promise.all([u.from("profiles").select("real_time_location_enabled").eq("user_id",r.id).single(),this.getUserLocationPreferences()]),i=null!=(e=null==(t=n.data)?void 0:t.real_time_location_enabled)&&e;return{enabled:i,auto_detect:!0,radius_km:(null==o?void 0:o.location_radius_km)||50,categories:(null==o?void 0:o.category)?[o.category]:[],notifications:(null==o?void 0:o.location_notifications)||!0}}catch(r){return{enabled:!1,auto_detect:!0,radius_km:50,categories:[],notifications:!0}}})}static updateLocationSettings(t){return s(this,null,function*(){var e;try{const{data:{user:r}}=yield u.auth.getUser();if(!r)throw new Error("User not authenticated");if(void 0!==t.enabled){const{error:e}=yield u.from("profiles").update({real_time_location_enabled:t.enabled}).eq("user_id",r.id);if(e)throw e}void 0===t.radius_km&&void 0===t.categories&&void 0===t.notifications||(yield this.saveUserLocationPreferences({location_radius_km:t.radius_km,category:(null==(e=t.categories)?void 0:e[0])||"general",location_notifications:t.notifications})),_()}catch(r){throw r}})}static getNearbyContent(t=50,e){return s(this,null,function*(){try{const r=yield this.getCurrentUserLocation();if(!r)return[];const{data:n,error:o}=yield u.rpc("get_nearby_content",{user_lat:r.lat,user_lng:r.lng,radius_km:t,content_type_filter:e||null});if(o)throw o;return n||[]}catch(r){return[]}})}static addContentLocation(t){return s(this,null,function*(){try{const{error:e}=yield u.from("content_location").insert(t);if(e)throw e}catch(e){throw e}})}static updateContentLocation(t,e,r){return s(this,null,function*(){try{const{error:n}=yield u.from("content_location").update(r).eq("content_type",t).eq("content_id",e);if(n)throw n}catch(n){throw n}})}static removeContentLocation(t,e){return s(this,null,function*(){try{const{error:r}=yield u.from("content_location").delete().eq("content_type",t).eq("content_id",e);if(r)throw r}catch(r){throw r}})}static searchPlaces(t,e){return s(this,null,function*(){return function(t,e){return s(this,null,function*(){try{const r=l.apiKey;if(!r)throw new Error("Google Maps API key not configured");let n=`https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(t)}&key=${r}`;e&&(n+=`&location=${e.lat},${e.lng}&radius=50000`);const o=yield fetch(n);if(!o.ok)throw new Error("Failed to fetch places data");const i=yield o.json();if("OK"===i.status)return i.results.map(t=>({id:t.place_id,name:t.name,address:t.formatted_address,lat:t.geometry.location.lat,lng:t.geometry.location.lng}));throw new Error(`Places API error: ${i.status}`)}catch(r){return[]}})}(t,e)})}static getLocationName(t,e){return s(this,null,function*(){return h(t,e)})}static toggleLocationServices(t){return s(this,null,function*(){try{const{data:{user:e}}=yield u.auth.getUser();if(!e)throw new Error("User not authenticated");const{error:r}=yield u.from("profiles").update({location_enabled:t,real_time_location_enabled:t}).eq("id",e.id);if(r)throw r;t||_()}catch(e){throw e}})}static getLocationStats(){return s(this,null,function*(){try{const t=yield this.getCurrentUserLocation(),e=yield this.getUserLocationPreferences();if(!t)return{total_content:0,nearby_content:0,user_radius_km:(null==e?void 0:e.location_radius_km)||50};const r=yield this.getNearbyContent((null==e?void 0:e.location_radius_km)||50),{count:n}=yield u.from("content_location").select("*",{count:"exact",head:!0});return{total_content:n||0,nearby_content:r.length,user_radius_km:(null==e?void 0:e.location_radius_km)||50}}catch(t){return{total_content:0,nearby_content:0,user_radius_km:50}}})}}((t,e,r)=>{a(t,"symbol"!=typeof e?e+"":e,r)})(g,"userPreferencesTableAvailable",null);export{g as L};
