var f=(h,m,u)=>new Promise((p,n)=>{var a=c=>{try{r(u.next(c))}catch(g){n(g)}},d=c=>{try{r(u.throw(c))}catch(g){n(g)}},r=c=>c.done?p(c.value):Promise.resolve(c.value).then(a,d);r((u=u.apply(h,m)).next())});import{r as v,u as S,g as q,s as l}from"./main-Dczk40-q.js";import{u as k}from"./useLocation-Cm6aJjbC.js";import{P}from"./pointsService-CuwYJ8TK.js";const N=()=>{const[h,m]=v.useState([]),[u,p]=v.useState(!0),{user:n}=S(),{toast:a}=q(),{currentLocation:d}=k(),r=v.useCallback(()=>f(void 0,null,function*(){var t,s,o,_,E,w,y,b;try{p(!0),console.log("Fetching events with function: get_events_with_attendance"),console.log("Supabase client initialized:",!!l),console.log("Current user auth state:",n?"authenticated":"unauthenticated");const{data:e,error:i}=yield l.rpc("get_events_with_attendance");if(i)throw console.error("Supabase RPC error details:",{message:i.message,details:i.details,hint:i.hint,code:i.code}),i;console.log("Events fetched successfully:",(e==null?void 0:e.length)||0,"events"),m(e||[])}catch(e){console.error("Error fetching events - Full error object:",e);let i="Failed to fetch events";(t=e==null?void 0:e.message)!=null&&t.includes("function")&&((s=e==null?void 0:e.message)!=null&&s.includes("does not exist"))?i="Database function not found. Please contact support.":(e==null?void 0:e.code)==="PGRST116"?i="Database function error. Please try again.":(o=e==null?void 0:e.message)!=null&&o.includes("JWT")?i="Authentication issue. Please try signing in again.":(_=e==null?void 0:e.message)!=null&&_.includes("network")||(E=e==null?void 0:e.message)!=null&&E.includes("fetch")||(w=e==null?void 0:e.message)!=null&&w.includes("NetworkError")?i="Network error. Please check your connection and try again.":(e==null?void 0:e.code)==="42883"?i="Database configuration error. Please contact support.":(e==null?void 0:e.code)==="42P01"?i="Database table not found. Please contact support.":(y=e==null?void 0:e.message)!=null&&y.includes("404")?i="Service endpoint not found. Please contact support.":(b=e==null?void 0:e.message)!=null&&b.includes("500")&&(i="Server error. Please try again in a few moments."),a({title:"Error",description:i,variant:"destructive"}),m([])}finally{p(!1)}}),[a,n]),c=t=>f(void 0,null,function*(){if(!n)return a({title:"Error",description:"You must be logged in to create events",variant:"destructive"}),!1;try{const{error:s}=yield l.from("events").insert({user_id:n.id,title:t.title,description:t.description,event_date:t.event_date,event_time:t.event_time,location_name:t.location_name,location_city:void 0,location_state:void 0,location_country:void 0,latitude:d==null?void 0:d.latitude,longitude:d==null?void 0:d.longitude,category:t.category,max_attendees:t.max_attendees,price:t.price||0,image_url:t.image_url,tags:t.tags});if(s)throw s;const{data:o}=yield l.from("events").select("id").eq("user_id",n.id).eq("title",t.title).order("created_at",{ascending:!1}).limit(1).single();return o&&(yield P.handleEventOrganization(o.id,n.id)),a({title:"Success",description:"Event created successfully!"}),r(),!0}catch(s){return console.error("Error creating event:",s),a({title:"Error",description:"Failed to create event",variant:"destructive"}),!1}}),g=t=>f(void 0,null,function*(){if(!n){a({title:"Error",description:"You must be logged in to attend events",variant:"destructive"});return}try{const s=h.find(o=>o.id===t);if(!s)return;if(s.user_attending){const{error:o}=yield l.from("event_attendees").delete().eq("event_id",t).eq("user_id",n.id);if(o)throw o;a({title:"Success",description:"You're no longer attending this event"})}else{const{error:o}=yield l.from("event_attendees").insert({event_id:t,user_id:n.id,status:"attending"});if(o)throw o;a({title:"Success",description:"You're now attending this event!"}),yield P.handleEventAttendance(t,n.id)}r()}catch(s){console.error("Error toggling attendance:",s),a({title:"Error",description:"Failed to update attendance",variant:"destructive"})}});return v.useEffect(()=>{r()},[n,r]),v.useEffect(()=>{const t=l.channel("events-changes").on("postgres_changes",{event:"*",schema:"public",table:"events"},()=>{r()}).subscribe();return()=>{l.removeChannel(t)}},[r]),{events:h,loading:u,createEvent:c,toggleAttendance:g,deleteEvent:t=>f(void 0,null,function*(){if(!n)return{error:new Error("Not authenticated")};try{const{error:s}=yield l.from("events").delete().eq("id",t).eq("user_id",n.id);if(s)throw s;return a({title:"Event deleted",description:"Your event has been deleted successfully."}),r(),{error:null}}catch(s){return a({title:"Error deleting event",description:s.message,variant:"destructive"}),{error:s}}}),refetch:r}};export{N as u};
