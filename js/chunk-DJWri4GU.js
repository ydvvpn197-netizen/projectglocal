var v=Object.defineProperty,S=Object.defineProperties;var U=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var p=(a,e,t)=>e in a?v(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,u=(a,e)=>{for(var t in e||(e={}))N.call(e,t)&&p(a,t,e[t]);if(L)for(var t of L(e))C.call(e,t)&&p(a,t,e[t]);return a},_=(a,e)=>S(a,U(e));var y=(a,e,t)=>p(a,typeof e!="symbol"?e+"":e,t);var i=(a,e,t)=>new Promise((r,o)=>{var c=s=>{try{g(t.next(s))}catch(n){o(n)}},f=s=>{try{g(t.throw(s))}catch(n){o(n)}},g=s=>s.done?r(s.value):Promise.resolve(s.value).then(c,f);g((t=t.apply(a,e)).next())});import{r as E}from"./chunk-V8Tq47hD.js";import{s as l,u as V,e as O}from"./main-nj8_qmr1.js";import{c as k,a as h}from"./chunk-M09l3cRM.js";const I={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_RETRY_ATTEMPTS:"3",VITE_API_RETRY_DELAY:"1000",VITE_API_TIMEOUT:"30000",VITE_APP_VERSION:"1.0.0",VITE_CACHE_DEFAULT_TTL:"300000",VITE_CACHE_MAX_SIZE:"100",VITE_ENABLE_ANALYTICS:"false",VITE_ENABLE_CODE_SPLITTING:"true",VITE_ENABLE_CSP:"true",VITE_ENABLE_DEBUG_MODE:"true",VITE_ENABLE_ERROR_TRACKING:"true",VITE_ENABLE_HSTS:"true",VITE_ENABLE_LAZY_LOADING:"true",VITE_ENABLE_LOGGING:"true",VITE_ENABLE_METRICS:"false",VITE_ENABLE_PERFORMANCE_MONITORING:"false",VITE_ENABLE_PERSISTENT_CACHE:"false",VITE_ENABLE_PRELOADING:"true",VITE_ENABLE_SERVICE_WORKER:"false",VITE_ENABLE_TRACING:"false",VITE_ENABLE_XSS_PROTECTION:"true",VITE_GOOGLE_MAPS_API_KEY:"AIzaSyBwdf6eMzFbsPcD12apX_PdCihrgun55YA",VITE_LOG_LEVEL:"info",VITE_MAX_LOGIN_ATTEMPTS:"5",VITE_NEWS_API_KEY:"edcc8605b836ce982b924ab1bbe45056",VITE_OPENAI_API_KEY:"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",VITE_SESSION_TIMEOUT:"3600000",VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlcHZ6aGJnb2Jja3lieWhyeXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzODIzNzQsImV4cCI6MjA2OTk1ODM3NH0.RBtDkdzRu-rgRs-kYHj9zlChhqO7lLvrnnVR2vBwji4",VITE_SUPABASE_URL:"https://tepvzhbgobckybyhryuj.supabase.co"},R=["VITE_SUPABASE_URL","VITE_SUPABASE_ANON_KEY"],D=()=>{const a=[];for(const e of R)(!I[e]||I[e].includes("placeholder"))&&a.push(e);if(a.length>0){const e=`Missing required environment variables: ${a.join(", ")}`;console.error(`❌ ${e}`)}};D();const M={apiKey:"AIzaSyBwdf6eMzFbsPcD12apX_PdCihrgun55YA"},B={googleMaps:M},{googleMaps:P}=B;function G(){return new Promise((a,e)=>{if(!navigator.geolocation){e(new Error("Geolocation is not supported by this browser"));return}navigator.geolocation.getCurrentPosition(t=>{const r={lat:t.coords.latitude,lng:t.coords.longitude};a(r)},t=>{e(new Error(`Geolocation error: ${t.message}`))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})})}function $(a,e){return i(this,null,function*(){try{const t=P.apiKey,r=yield fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${a},${e}&key=${t}`);if(!r.ok)throw new Error("Failed to fetch geocoding data");const o=yield r.json();if(o.status==="OK"&&o.results.length>0)return o.results[0].formatted_address;throw new Error("No results found for coordinates")}catch(t){return console.error("Reverse geocoding error:",t),`${a.toFixed(6)}, ${e.toFixed(6)}`}})}function Y(a,e){return i(this,null,function*(){try{const t=P.apiKey;let r=`https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(a)}&key=${t}`;e&&(r+=`&location=${e.lat},${e.lng}&radius=50000`);const o=yield fetch(r);if(!o.ok)throw new Error("Failed to fetch places data");const c=yield o.json();if(c.status==="OK")return c.results.map(f=>({id:f.place_id,name:f.name,address:f.formatted_address,lat:f.geometry.location.lat,lng:f.geometry.location.lng}));throw new Error(`Places API error: ${c.status}`)}catch(t){return console.error("Places search error:",t),[]}})}function A(a,e){return i(this,null,function*(){try{const t=yield $(a,e),r=t.split(",");return r.length>=2?r[1].trim():t}catch(t){return console.error("Error getting location name:",t),`${a.toFixed(4)}, ${e.toFixed(4)}`}})}function m(a,e,t=3e5){try{const r={data:e,timestamp:Date.now(),ttl:t};localStorage.setItem(`location_cache_${a}`,JSON.stringify(r))}catch(r){console.error("Error caching location data:",r)}}function z(a){try{const e=localStorage.getItem(`location_cache_${a}`);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>t.ttl?(localStorage.removeItem(`location_cache_${a}`),null):t.data}catch(e){return console.error("Error getting cached location data:",e),null}}function T(){try{Object.keys(localStorage).forEach(e=>{e.startsWith("location_cache_")&&localStorage.removeItem(e)})}catch(a){console.error("Error clearing location cache:",a)}}class w{static checkUserPreferencesTable(){return i(this,null,function*(){if(this.userPreferencesTableAvailable!==null)return this.userPreferencesTableAvailable;try{const e=yield k("user_preferences");return this.userPreferencesTableAvailable=e.exists,this.userPreferencesTableAvailable?console.log("User preferences table is available and accessible."):console.warn("User preferences table not available. Using fallback preferences."),this.userPreferencesTableAvailable}catch(e){return console.error("Error checking user preferences table:",e),this.userPreferencesTableAvailable=!1,!1}})}static getCurrentUserLocation(){return i(this,null,function*(){try{const{data:{user:e}}=yield l.auth.getUser();if(!e)return null;const t=z(`user_${e.id}`);if(t)return t;const{data:r}=yield l.from("profiles").select("latitude, longitude, real_time_location_enabled, location_city, location_state, location_country").eq("user_id",e.id).single();if(r&&r.latitude&&r.longitude){const o={lat:r.latitude,lng:r.longitude,name:r.location_city?`${r.location_city}, ${r.location_state||""}`.trim():void 0};return m(`user_${e.id}`,o),o}return null}catch(e){return console.error("Error getting current user location:",e),null}})}static getUserLocationPreferences(){return i(this,null,function*(){try{if(!(yield this.checkUserPreferencesTable()))return console.warn("User preferences table not available. Using fallback preferences."),h();const{data:{user:t}}=yield l.auth.getUser();if(!t)return h();const{data:r,error:o}=yield l.from("user_preferences").select("*").eq("user_id",t.id).single();if(o&&o.code!=="PGRST116")return console.error("Error fetching user preferences:",o),h();if(!r){const c=h();return yield this.saveUserLocationPreferences(c),c}return u(u({},h()),r)}catch(e){return console.error("Error getting user location preferences:",e),h()}})}static saveUserLocationPreferences(e){return i(this,null,function*(){try{if(!(yield this.checkUserPreferencesTable()))return console.warn("User preferences table not available. Preferences not saved."),!1;const{data:{user:r}}=yield l.auth.getUser();if(!r)throw new Error("User not authenticated");const{error:o}=yield l.from("user_preferences").upsert(_(u({user_id:r.id},e),{updated_at:new Date().toISOString()}),{onConflict:"user_id"});if(o)throw o;return!0}catch(t){return console.error("Error saving user location preferences:",t),!1}})}static detectAndSaveLocation(){return i(this,null,function*(){try{const{data:{user:e}}=yield l.auth.getUser();if(!e)throw new Error("User not authenticated");const t=yield G(),r=yield A(t.lat,t.lng);t.name=r;const{error:o}=yield l.rpc("update_user_location",{user_uuid:e.id,lat:t.lat,lng:t.lng,location_name:r});if(o)throw o;return m(`user_${e.id}`,t),t}catch(e){return console.error("Error detecting and saving location:",e),null}})}static setManualLocation(e){return i(this,null,function*(){try{const{data:{user:t}}=yield l.auth.getUser();if(!t)throw new Error("User not authenticated");const{error:r}=yield l.rpc("update_user_location",{user_uuid:t.id,lat:e.lat,lng:e.lng,location_name:e.name||null});if(r)throw r;m(`user_${t.id}`,e)}catch(t){throw console.error("Error setting manual location:",t),t}})}static getUserPreferences(){return i(this,null,function*(){try{const{data:{user:e}}=yield l.auth.getUser();if(!e)return null;const{data:t,error:r}=yield l.from("user_preferences").select("*").eq("user_id",e.id).single();if(r&&r.code!=="PGRST116")throw r;return t}catch(e){return console.error("Error getting user preferences:",e),null}})}static updateUserPreferences(e){return i(this,null,function*(){try{const{data:{user:t}}=yield l.auth.getUser();if(!t)throw new Error("User not authenticated");const{error:r}=yield l.from("user_preferences").upsert(u({user_id:t.id},e));if(r)throw r}catch(t){throw console.error("Error updating user preferences:",t),t}})}static getLocationSettings(){return i(this,null,function*(){var e,t;try{const{data:{user:r}}=yield l.auth.getUser();if(!r)throw new Error("User not authenticated");const[o,c]=yield Promise.all([l.from("profiles").select("real_time_location_enabled").eq("user_id",r.id).single(),this.getUserLocationPreferences()]);return{enabled:(t=(e=o.data)==null?void 0:e.real_time_location_enabled)!=null?t:!1,auto_detect:!0,radius_km:(c==null?void 0:c.location_radius_km)||50,categories:c!=null&&c.category?[c.category]:[],notifications:(c==null?void 0:c.location_notifications)||!0}}catch(r){return console.error("Error getting location settings:",r),{enabled:!1,auto_detect:!0,radius_km:50,categories:[],notifications:!0}}})}static updateLocationSettings(e){return i(this,null,function*(){var t;try{const{data:{user:r}}=yield l.auth.getUser();if(!r)throw new Error("User not authenticated");if(e.enabled!==void 0){const{error:o}=yield l.from("profiles").update({real_time_location_enabled:e.enabled}).eq("user_id",r.id);if(o)throw o}(e.radius_km!==void 0||e.categories!==void 0||e.notifications!==void 0)&&(yield this.saveUserLocationPreferences({location_radius_km:e.radius_km,category:((t=e.categories)==null?void 0:t[0])||"general",location_notifications:e.notifications})),T()}catch(r){throw console.error("Error updating location settings:",r),r}})}static getNearbyContent(e=50,t){return i(this,null,function*(){try{const r=yield this.getCurrentUserLocation();if(!r)return[];const{data:o,error:c}=yield l.rpc("get_nearby_content",{user_lat:r.lat,user_lng:r.lng,radius_km:e,content_type_filter:t||null});if(c)throw c;return o||[]}catch(r){return console.error("Error getting nearby content:",r),[]}})}static addContentLocation(e){return i(this,null,function*(){try{const{error:t}=yield l.from("content_location").insert(e);if(t)throw t}catch(t){throw console.error("Error adding content location:",t),t}})}static updateContentLocation(e,t,r){return i(this,null,function*(){try{const{error:o}=yield l.from("content_location").update(r).eq("content_type",e).eq("content_id",t);if(o)throw o}catch(o){throw console.error("Error updating content location:",o),o}})}static removeContentLocation(e,t){return i(this,null,function*(){try{const{error:r}=yield l.from("content_location").delete().eq("content_type",e).eq("content_id",t);if(r)throw r}catch(r){throw console.error("Error removing content location:",r),r}})}static searchPlaces(e,t){return i(this,null,function*(){return Y(e,t)})}static getLocationName(e,t){return i(this,null,function*(){return A(e,t)})}static toggleLocationServices(e){return i(this,null,function*(){try{const{data:{user:t}}=yield l.auth.getUser();if(!t)throw new Error("User not authenticated");const{error:r}=yield l.from("profiles").update({location_enabled:e,real_time_location_enabled:e}).eq("id",t.id);if(r)throw r;e||T()}catch(t){throw console.error("Error toggling location services:",t),t}})}static getLocationStats(){return i(this,null,function*(){try{const e=yield this.getCurrentUserLocation(),t=yield this.getUserLocationPreferences();if(!e)return{total_content:0,nearby_content:0,user_radius_km:(t==null?void 0:t.location_radius_km)||50};const r=yield this.getNearbyContent((t==null?void 0:t.location_radius_km)||50),{count:o}=yield l.from("content_location").select("*",{count:"exact",head:!0});return{total_content:o||0,nearby_content:r.length,user_radius_km:(t==null?void 0:t.location_radius_km)||50}}catch(e){return console.error("Error getting location stats:",e),{total_content:0,nearby_content:0,user_radius_km:50}}})}}y(w,"userPreferencesTableAvailable",null);const K=()=>{const{user:a}=V(),{toast:e}=O(),[t,r]=E.useState({currentLocation:null,isEnabled:!1,isLoading:!1,error:null,lastUpdated:null});E.useEffect(()=>{i(null,null,function*(){if(a)try{const n=yield w.getCurrentUserLocation(),d=yield w.getLocationSettings();r(n?b=>_(u({},b),{isEnabled:d.enabled,currentLocation:{latitude:n.lat,longitude:n.lng},lastUpdated:new Date}):b=>_(u({},b),{isEnabled:d.enabled,currentLocation:null}))}catch(n){console.error("Error loading location preferences:",n)}})},[a]);const o=E.useCallback(()=>new Promise((s,n)=>{if(!navigator.geolocation){n(new Error("Geolocation is not supported by this browser"));return}navigator.geolocation.getCurrentPosition(d=>{s({latitude:d.coords.latitude,longitude:d.coords.longitude,accuracy:d.coords.accuracy})},d=>{n(new Error(`Location error: ${d.message}`))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}),[]),c=E.useCallback(s=>i(null,null,function*(){if(a)try{const n={lat:s.latitude,lng:s.longitude};yield w.setManualLocation(n)}catch(n){throw console.error("Error updating location in database:",n),n}}),[a]),f=E.useCallback(()=>i(null,null,function*(){if(a){r(s=>_(u({},s),{isLoading:!0,error:null}));try{if(!t.isEnabled){const n=yield o(),d={lat:n.latitude,lng:n.longitude};yield w.detectAndSaveLocation(),r(b=>_(u({},b),{isEnabled:!0,currentLocation:n,lastUpdated:new Date,isLoading:!1})),e({title:"Location sharing enabled",description:"Your location will be used to show relevant local content."})}else yield w.toggleLocationServices(!1),r(n=>_(u({},n),{isEnabled:!1,currentLocation:null,lastUpdated:null,isLoading:!1})),e({title:"Location sharing disabled",description:"Location data has been cleared."})}catch(s){const n=s instanceof Error?s.message:"Unknown error";r(d=>_(u({},d),{error:n,isLoading:!1})),e({title:"Location error",description:n,variant:"destructive"})}}}),[a,t.isEnabled,o,e]),g=E.useCallback(()=>i(null,null,function*(){if(!(!a||!t.isEnabled)){r(s=>_(u({},s),{isLoading:!0,error:null}));try{const s=yield o();yield c(s),r(n=>_(u({},n),{currentLocation:s,lastUpdated:new Date,isLoading:!1})),e({title:"Location updated",description:"Your current location has been refreshed."})}catch(s){const n=s instanceof Error?s.message:"Location update failed";r(d=>_(u({},d),{error:n,isLoading:!1})),e({title:"Location update failed",description:n,variant:"destructive"})}}}),[a,t.isEnabled,o,c,e]);return E.useEffect(()=>{if(!t.isEnabled)return;const s=setInterval(()=>{g()},900*1e3);return()=>clearInterval(s)},[t.isEnabled,g]),_(u({},t),{toggleLocationSharing:f,updateCurrentLocation:g})};export{K as u};
