var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,n=(s,t,i)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i,a=(e,s,t)=>new Promise((i,r)=>{var o=e=>{try{a(t.next(e))}catch(s){r(s)}},n=e=>{try{a(t.throw(e))}catch(s){r(s)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,n);a((t=t.apply(e,s)).next())});import{r as c,u as l,d as u,s as d,b as m,j as p,B as j,C as h,v as y,w as x,x as f,y as g}from"./main-u5iDOJMZ.js";import{I as v}from"./input-d0wpgTJ2.js";import{T as b}from"./textarea-44C4KWaW.js";import{S as N,a as w,b as C,c as S,d as _}from"./select-BloqB5ko.js";import{L as D}from"./label-BmJUPftL.js";import{C as E}from"./checkbox-GtjjLUMs.js";import{R as P}from"./ResponsiveLayout-CaFEj6Sr.js";import{u as k}from"./useLocation-DoOmcXMP.js";import{A}from"./arrow-left-C3YI5YUq.js";import{M as O}from"./message-circle-nfkvwkJk.js";import"./index-jVOyRz7F.js";import"./index-Dy-VqNBB.js";import"./Combination-D3NAapk3.js";import"./index-9dp5BQ5P.js";import"./chevron-up-MfWNy2Yr.js";import"./check-CT-bNmTi.js";import"./separator-BdZu64Yb.js";import"./sheet-BES5Q-Ko.js";import"./index-B7-3ofi9.js";import"./NotificationBell-4ukuyDx4.js";import"./badge-k0SsuPwB.js";import"./scroll-area-DANvZfFy.js";import"./useNotifications-DNCpc7NU.js";import"./tabs-Dn7YRzvT.js";import"./bell-wBykza9e.js";import"./user-DlaYKRnl.js";import"./index-azXaBhbR.js";import"./NotificationButton-QcrDLMMB.js";import"./search-BsWmJlwB.js";import"./map-pin-CcmxiK6P.js";import"./users-BKDXsamp.js";import"./zap-BrBeKdrO.js";import"./message-square-DQ5316cR.js";import"./alert-7nHfBPfv.js";import"./wifi-DNTf1l7S.js";import"./log-out-CGc8M4_-.js";import"./locationService-DDZ4T3aM.js";const I=()=>{const e=m(),{toast:I}=u(),{user:F}=l(),{createDiscussion:q}=(()=>{const[e,s]=c.useState([]),[t,i]=c.useState(!0),{user:r}=l(),{toast:o}=u(),{currentLocation:n}=k(),m=c.useCallback(()=>a(void 0,null,function*(){try{i(!0);const{data:e,error:t}=yield d.rpc("get_discussions_with_details");if(t)throw t;s(e||[])}catch(e){o({title:"Error",description:"Failed to fetch discussions",variant:"destructive"})}finally{i(!1)}}),[o]);return c.useEffect(()=>{r&&m()},[r,m]),{discussions:e,loading:t,createDiscussion:e=>a(void 0,null,function*(){if(!r)return o({title:"Error",description:"You must be logged in to create discussions",variant:"destructive"}),!1;try{const{error:s}=yield d.from("discussions").insert({user_id:r.id,title:e.title,content:e.content,category:e.category||"general",is_anonymous:e.is_anonymous||!1,group_id:e.group_id||null,latitude:null==n?void 0:n.latitude,longitude:null==n?void 0:n.longitude});if(s)throw s;return o({title:"Success",description:"Discussion created successfully!"}),m(),!0}catch(s){return o({title:"Error",description:"Failed to create discussion",variant:"destructive"}),!1}}),deleteDiscussion:e=>a(void 0,null,function*(){if(!r)return{error:new Error("Not authenticated")};try{const{error:s}=yield d.from("discussions").delete().eq("id",e).eq("user_id",r.id);if(s)throw s;return o({title:"Discussion deleted",description:"Your discussion has been deleted successfully."}),m(),{error:null}}catch(s){return o({title:"Error deleting discussion",description:s.message,variant:"destructive"}),{error:s}}}),refetch:m}})(),[L,B]=c.useState(!1),[R,T]=c.useState([]),[z,G]=c.useState({title:"",content:"",groupId:"",category:"general",isAnonymous:!1});c.useEffect(()=>{(()=>{a(void 0,null,function*(){if(F)try{const{data:e,error:s}=yield d.from("groups").select("\n            id,\n            name,\n            description,\n            category,\n            group_members!inner (role)\n          ").eq("group_members.user_id",F.id);if(s)throw s;T(e||[])}catch(e){}})})()},[F]);const K=(e,a)=>{G(c=>((e,i)=>s(e,t(i)))(((e,s)=>{for(var t in s||(s={}))r.call(s,t)&&n(e,t,s[t]);if(i)for(var t of i(s))o.call(s,t)&&n(e,t,s[t]);return e})({},c),{[e]:a}))};return p.jsx(P,{children:p.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[p.jsx("div",{className:"flex items-center gap-4",children:p.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>e("/community"),className:"flex items-center gap-2",children:[p.jsx(A,{className:"h-4 w-4"}),"Back to Community"]})}),p.jsxs(h,{children:[p.jsxs(y,{children:[p.jsxs("div",{className:"flex items-center gap-2",children:[p.jsx(O,{className:"h-6 w-6 text-primary"}),p.jsx(x,{className:"text-2xl",children:"Start a Discussion"})]}),p.jsx(f,{children:"Share your thoughts and engage with your community"})]}),p.jsx(g,{children:p.jsxs("form",{onSubmit:s=>a(void 0,null,function*(){if(s.preventDefault(),F)if(z.title.trim()&&z.content.trim())if(z.isAnonymous||z.groupId){B(!0);try{(yield q({title:z.title,content:z.content,category:z.category,is_anonymous:z.isAnonymous,group_id:z.isAnonymous?void 0:z.groupId}))&&e("/community")}catch(t){}finally{B(!1)}}else I({title:"Error",description:"Please select a group or choose anonymous discussion.",variant:"destructive"});else I({title:"Error",description:"Please fill in title and content.",variant:"destructive"})}),className:"space-y-6",children:[p.jsxs("div",{className:"space-y-4",children:[p.jsxs("div",{className:"flex items-center space-x-2",children:[p.jsx(E,{id:"anonymous",checked:z.isAnonymous,onCheckedChange:e=>K("isAnonymous",e)}),p.jsx(D,{htmlFor:"anonymous",className:"text-sm font-medium",children:"Post anonymously (without joining a group)"})]}),!z.isAnonymous&&p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"group",children:"Group *"}),p.jsxs(N,{value:z.groupId,onValueChange:e=>K("groupId",e),children:[p.jsx(w,{children:p.jsx(C,{placeholder:"Select a group to post in"})}),p.jsx(S,{children:R.map(e=>p.jsx(_,{value:e.id,children:e.name},e.id))})]})]})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"title",children:"Discussion Title *"}),p.jsx(v,{id:"title",placeholder:"What would you like to discuss?",value:z.title,onChange:e=>K("title",e.target.value),className:"text-lg"})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"content",children:"Description *"}),p.jsx(b,{id:"content",placeholder:"Provide more details about your discussion...",value:z.content,onChange:e=>K("content",e.target.value),rows:6})]}),p.jsxs("div",{className:"space-y-2",children:[p.jsx(D,{htmlFor:"category",children:"Category"}),p.jsxs(N,{value:z.category,onValueChange:e=>K("category",e),children:[p.jsx(w,{children:p.jsx(C,{})}),p.jsxs(S,{children:[p.jsx(_,{value:"general",children:"General"}),p.jsx(_,{value:"question",children:"Question"}),p.jsx(_,{value:"event",children:"Event"}),p.jsx(_,{value:"recommendation",children:"Recommendation"}),p.jsx(_,{value:"announcement",children:"Announcement"})]})]})]}),p.jsxs("div",{className:"flex gap-4 pt-4",children:[p.jsx(j,{type:"button",variant:"outline",onClick:()=>e("/community"),className:"flex-1",children:"Cancel"}),p.jsx(j,{type:"submit",disabled:L||!z.title.trim()||!z.content.trim()||!z.isAnonymous&&!z.groupId,className:"flex-1",children:L?"Creating...":"Start Discussion"})]})]})})]})]})})};export{I as default};
