var b=Object.defineProperty,f=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var _=(u,e,r)=>e in u?b(u,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[e]=r,m=(u,e)=>{for(var r in e||(e={}))E.call(e,r)&&_(u,r,e[r]);if(y)for(var r of y(e))q.call(e,r)&&_(u,r,e[r]);return u},h=(u,e)=>f(u,G(e));var c=(u,e,r)=>new Promise((o,t)=>{var a=l=>{try{i(r.next(l))}catch(p){t(p)}},n=l=>{try{i(r.throw(l))}catch(p){t(p)}},i=l=>l.done?o(l.value):Promise.resolve(l.value).then(a,n);i((r=r.apply(u,e)).next())});import{s}from"./main-B2Z1A0fl.js";class v{static ensureAuthenticated(){return c(this,null,function*(){try{const{data:{user:e},error:r}=yield s.auth.getUser();if(r)throw console.error("Auth error:",r),new Error("Authentication error");if(!e)throw new Error("User not authenticated");return e}catch(e){throw console.error("Authentication check failed:",e),new Error("User not authenticated")}})}static retryOperation(e,r=3,o=1e3){return c(this,null,function*(){let t;for(let a=1;a<=r;a++)try{return yield e()}catch(n){t=n,console.warn(`Operation failed (attempt ${a}/${r}):`,n),a<r&&(yield new Promise(i=>setTimeout(i,o*a)))}throw t})}static createGroup(e){return c(this,null,function*(){try{const r=yield this.ensureAuthenticated(),{data:o,error:t}=yield s.from("groups").insert(h(m({},e),{created_by:r.id})).select().single();if(t)throw t;return yield this.addGroupMember(o.id,r.id,"admin"),o}catch(r){return console.error("Error creating group:",r),null}})}static getGroups(e){return c(this,null,function*(){try{let r=s.from("community_groups").select("*").order("created_at",{ascending:!1});e!=null&&e.category&&(r=r.eq("category",e.category)),(e==null?void 0:e.is_public)!==void 0&&(r=r.eq("is_public",e.is_public)),e!=null&&e.location_city&&(r=r.eq("location_city",e.location_city)),e!=null&&e.member_count_min&&(r=r.gte("member_count",e.member_count_min));const{data:o,error:t}=yield r;if(t)throw t;if(!o||o.length===0){console.log("No groups found, creating sample groups..."),yield this.createSampleGroups();const{data:a,error:n}=yield r;if(n)throw n;return a||[]}return o||[]}catch(r){return console.error("Error fetching groups:",r),[]}})}static createSampleGroups(){return c(this,null,function*(){try{const{data:{user:e}}=yield s.auth.getUser(),r=(e==null?void 0:e.id)||"00000000-0000-0000-0000-000000000000",o=[{name:"Local Artists Network",description:"Connect with local artists and share your work",category:"Arts & Culture",created_by:r,location_city:"New York",location_state:"NY",location_country:"USA",is_public:!0,member_count:0,post_count:0},{name:"Tech Enthusiasts",description:"Discuss the latest in technology and innovation",category:"Technology",created_by:r,location_city:"San Francisco",location_state:"CA",location_country:"USA",is_public:!0,member_count:0,post_count:0},{name:"Food Lovers",description:"Share recipes and discover local restaurants",category:"Food & Dining",created_by:r,location_city:"Chicago",location_state:"IL",location_country:"USA",is_public:!0,member_count:0,post_count:0}];for(const t of o){const{error:a}=yield s.from("groups").insert(t);a&&a.code!=="23505"&&console.error("Error creating sample group:",a)}console.log("Sample groups created successfully")}catch(e){console.error("Error creating sample groups:",e)}})}static getGroupById(e){return c(this,null,function*(){try{const{data:r,error:o}=yield s.from("groups").select("*").eq("id",e).single();if(o)throw o;return r}catch(r){return console.error("Error fetching group:",r),null}})}static updateGroup(e,r){return c(this,null,function*(){try{const{error:o}=yield s.from("groups").update(r).eq("id",e);if(o)throw o;return!0}catch(o){return console.error("Error updating group:",o),!1}})}static deleteGroup(e){return c(this,null,function*(){try{const{error:r}=yield s.from("groups").delete().eq("id",e);if(r)throw r;return!0}catch(r){return console.error("Error deleting group:",r),!1}})}static addGroupMember(e,r,o="member"){return c(this,null,function*(){return this.retryOperation(()=>c(this,null,function*(){try{console.log("=== DEBUG: addGroupMember ==="),console.log("Group ID:",e),console.log("User ID:",r),console.log("Role:",o);const t=yield this.ensureAuthenticated();console.log("Authenticated user:",t==null?void 0:t.id),console.log("Checking if group exists...");const a=yield this.getGroupById(e);if(console.log("Group found:",a),!a)throw console.error("Group not found:",e),new Error("Group not found");if(!a.is_public)throw new Error("Cannot join private group");console.log("Checking if user is already a member...");const n=yield this.isGroupMember(e,r);if(console.log("Is member:",n),n)return console.log("User is already a member of group:",e),!0;console.log("Attempting to add user",r,"to group",e),console.log("Verifying user exists in auth.users...");const{data:i,error:l}=yield s.from("auth.users").select("id").eq("id",r).single();console.log("User verification result:",{userData:i,userError:l});const{error:p}=yield s.from("group_members").insert({group_id:e,user_id:r,role:o});if(p){if(console.error("Supabase error adding group member:",p),p.code==="23505")return console.log("User already a member (unique constraint)"),!0;if(p.code==="23503"){console.error("Foreign key constraint violation. Group ID:",e,"User ID:",r);const{data:d}=yield s.from("groups").select("id, name").eq("id",e);console.log("Group check result:",d);const{data:g}=yield s.from("auth.users").select("id").eq("id",r);throw console.log("User check result:",g),new Error("Invalid group or user ID")}throw p}return console.log("Successfully added user to group"),yield this.updateGroupMemberCount(e),!0}catch(t){throw console.error("Error adding group member:",t),t}}))})}static removeGroupMember(e,r){return c(this,null,function*(){return this.retryOperation(()=>c(this,null,function*(){try{yield this.ensureAuthenticated();const{error:o}=yield s.from("group_members").delete().eq("group_id",e).eq("user_id",r);if(o)throw o;return yield this.updateGroupMemberCount(e),!0}catch(o){throw console.error("Error removing group member:",o),o}}))})}static getGroupMembers(e){return c(this,null,function*(){try{const{data:r,error:o}=yield s.from("group_members").select(`
          *,
          profiles:user_id (
            display_name,
            avatar_url
          )
        `).eq("group_id",e).order("joined_at",{ascending:!0});if(o)throw o;return(r||[]).map(t=>{var a,n;return h(m({},t),{user_name:(a=t.profiles)==null?void 0:a.display_name,user_avatar:(n=t.profiles)==null?void 0:n.avatar_url})})}catch(r){return console.error("Error fetching group members:",r),[]}})}static getUserGroups(e){return c(this,null,function*(){return this.retryOperation(()=>c(this,null,function*(){try{yield this.ensureAuthenticated();const{data:r,error:o}=yield s.from("group_members").select(`
            groups (*)
          `).eq("user_id",e);if(o)throw console.error("Supabase error fetching user groups:",o),o;return(r||[]).map(t=>t.groups)}catch(r){throw console.error("Error fetching user groups:",r),r}}))})}static isGroupMember(e,r){return c(this,null,function*(){try{const{data:o,error:t}=yield s.from("group_members").select("id").eq("group_id",e).eq("user_id",r).single();if(t&&t.code!=="PGRST116")throw t;return!!o}catch(o){return console.error("Error checking group membership:",o),!1}})}static getUserRole(e,r){return c(this,null,function*(){try{const{data:o,error:t}=yield s.from("group_members").select("role").eq("group_id",e).eq("user_id",r).single();if(t&&t.code!=="PGRST116")throw t;return(o==null?void 0:o.role)||null}catch(o){return console.error("Error getting user role:",o),null}})}static updateGroupMemberCount(e){return c(this,null,function*(){try{const{count:r,error:o}=yield s.from("group_members").select("*",{count:"exact",head:!0}).eq("group_id",e);if(o)throw o;yield s.from("groups").update({member_count:r||0}).eq("id",e)}catch(r){console.error("Error updating member count:",r)}})}static validateGroupForJoining(e,r){return c(this,null,function*(){const o=[];try{const t=yield this.getGroupById(e);t?t.is_public||o.push("Group is not public"):o.push("Group does not exist");const{data:{user:a},error:n}=yield s.auth.getUser();return n||!a?o.push("User not authenticated"):a.id!==r&&o.push("User ID mismatch"),t&&a&&(yield this.isGroupMember(e,r))&&o.push("User is already a member"),{isValid:o.length===0,group:t,user:a,errors:o}}catch(t){return o.push(`Validation error: ${t}`),{isValid:!1,errors:o}}})}static debugGroupIssues(){return c(this,null,function*(){try{console.log("=== DEBUG: Group Issues ===");const{data:e,error:r}=yield s.from("groups").select("id, name, is_public, created_at, created_by").limit(10),{data:o,error:t}=yield s.from("group_members").select("id, group_id, user_id, role").limit(10),{data:{user:a},error:n}=yield s.auth.getUser(),{data:i,error:l}=yield s.from("group_members").select("group_id, user_id").not("group_id","in",`(${(e==null?void 0:e.map(w=>`'${w.id}'`).join(","))||""})`),{data:p,error:d}=yield s.rpc("get_rls_policies",{table_name:"group_members"}).catch(()=>({data:null,error:"RPC not available"})),g={groups:e||[],members:o||[],orphanedMembers:i||[],currentUser:a,errors:{groups:r,members:t,user:n,orphaned:l,rls:d},summary:{totalGroups:(e==null?void 0:e.length)||0,totalMembers:(o==null?void 0:o.length)||0,orphanedMembers:(i==null?void 0:i.length)||0,userAuthenticated:!!a}};return console.log("Debug Info:",g),g}catch(e){return console.error("Debug error:",e),{error:e}}})}static searchGroups(e,r){return c(this,null,function*(){try{let o=s.from("groups").select("*").or(`name.ilike.%${e}%,description.ilike.%${e}%`).eq("is_public",!0).order("member_count",{ascending:!1});r!=null&&r.category&&(o=o.eq("category",r.category)),r!=null&&r.location_city&&(o=o.eq("location_city",r.location_city));const{data:t,error:a}=yield o;if(a)throw a;return t||[]}catch(o){return console.error("Error searching groups:",o),[]}})}static getTrendingGroups(e=10){return c(this,null,function*(){try{const{data:r,error:o}=yield s.from("groups").select("*").eq("is_public",!0).order("member_count",{ascending:!1}).order("post_count",{ascending:!1}).limit(e);if(o)throw o;return r||[]}catch(r){return console.error("Error fetching trending groups:",r),[]}})}static getGroupsByCategory(e){return c(this,null,function*(){try{const{data:r,error:o}=yield s.from("groups").select("*").eq("category",e).eq("is_public",!0).order("member_count",{ascending:!1});if(o)throw o;return r||[]}catch(r){return console.error("Error fetching groups by category:",r),[]}})}static getGroupsByLocation(e){return c(this,null,function*(){try{let r=s.from("groups").select("*").eq("is_public",!0);e.city&&(r=r.eq("location_city",e.city)),e.state&&(r=r.eq("location_state",e.state)),e.country&&(r=r.eq("location_country",e.country));const{data:o,error:t}=yield r.order("member_count",{ascending:!1});if(t)throw t;return o||[]}catch(r){return console.error("Error fetching groups by location:",r),[]}})}}export{v as C};
