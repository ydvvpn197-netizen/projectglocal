var A=Object.defineProperty,T=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var E=(r,t,a)=>t in r?A(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a,C=(r,t)=>{for(var a in t||(t={}))$.call(t,a)&&E(r,a,t[a]);if(b)for(var a of b(t))F.call(t,a)&&E(r,a,t[a]);return r},S=(r,t)=>T(r,q(t));var N=(r,t,a)=>new Promise((s,u)=>{var f=n=>{try{d(a.next(n))}catch(l){u(l)}},c=n=>{try{d(a.throw(n))}catch(l){u(l)}},d=n=>n.done?s(n.value):Promise.resolve(n.value).then(f,c);d((a=a.apply(r,t)).next())});import{u as L,g as z,r as x,s as j,j as e,C as P,v as k,B as v,X as B,M as G,f as K,p as O,q as R}from"./main-Dczk40-q.js";import{n as U}from"./notificationService-DiBkqnn5.js";import{R as M,A as I,b as H,c as X}from"./ResponsiveLayout-CxdDAcTl.js";import{T as J}from"./textarea-fzgM4rGq.js";import{S as Q}from"./send-BRD3uoba.js";import{A as V}from"./arrow-left-CzEz-wbP.js";import{f as D}from"./index-BCwUGNws.js";import"./index-DxDoSqvO.js";import"./separator-CnmZayxo.js";import"./index-Bvi8qGb8.js";import"./index-p4sF6Wge.js";import"./databaseUtils-DDxBFZda.js";import"./badge-iBsRNaSn.js";import"./scroll-area-Ya-nYYPz.js";import"./tabs-ChvN7mKq.js";import"./useNotifications-DdfHYMMR.js";import"./bell-CB9MQoCr.js";import"./check-Dn5E7z_E.js";import"./user-xzPyfs-H.js";import"./search-CoqTXUJe.js";import"./calendar-DbYgxsnG.js";import"./alert-vAohCTxn.js";import"./zap-BM2f935p.js";import"./plus-B7hFD5Z2.js";import"./message-square-BskFJ3te.js";import"./map-pin-B65WKje7.js";import"./wifi-D1BoRTe0.js";import"./log-out-vClmguiA.js";const W=r=>{const{user:t}=L(),{toast:a}=z(),[s,u]=x.useState(null),[f,c]=x.useState([]),[d,n]=x.useState(!0),l=x.useRef(null);x.useEffect(()=>{if(!r||!t)return;n(!0),g(),m();const i=j.channel(`chat_messages_${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`conversation_id=eq.${r}`},o=>{c(p=>[...p,o.new])}).subscribe();return l.current=i,()=>{l.current&&j.removeChannel(l.current)}},[r,t==null?void 0:t.id]);const g=()=>N(void 0,null,function*(){try{const{data:i,error:o}=yield j.from("chat_conversations").select("*").eq("id",r).single();if(o)throw console.error("Error fetching conversation:",o),o;if(!i)throw console.error("No conversation found for ID:",r),new Error("Conversation not found");const p=i.client_id===(t==null?void 0:t.id)?i.artist_id:i.client_id,{data:w,error:_}=yield j.from("profiles").select("user_id, display_name, avatar_url").eq("user_id",p).single();_&&console.error("Error fetching profile:",_),u(S(C({},i),{other_user:w||void 0}))}catch(i){console.error("Error fetching conversation:",i),a({title:"Error",description:i instanceof Error?i.message:"Failed to load conversation",variant:"destructive"})}finally{n(!1)}}),m=()=>N(void 0,null,function*(){try{const{data:i,error:o}=yield j.from("chat_messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});if(o)throw o;c(i||[])}catch(i){console.error("Error fetching messages:",i),a({title:"Error",description:i instanceof Error?i.message:"Failed to load messages",variant:"destructive"})}}),h=i=>N(void 0,null,function*(){if(!t||!r){a({title:"Error",description:"Unable to send message. Please try again.",variant:"destructive"});return}try{const{error:o}=yield j.from("chat_messages").insert({conversation_id:r,sender_id:t.id,message:i,message_type:"text"});if(o)throw console.error("Error sending message:",o),a({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"}),o;if((s==null?void 0:s.status)==="pending"){const p=t.id===(s==null?void 0:s.client_id)?s==null?void 0:s.artist_id:s==null?void 0:s.client_id;if(p)try{yield U.createMessageRequestNotification(p,t.id,r)}catch(w){console.error("Error creating message request notification:",w)}}}catch(o){throw console.error("Error in sendMessage:",o),a({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"}),o}}),y=x.useMemo(()=>i=>i===(t==null?void 0:t.id),[t==null?void 0:t.id]);return{loading:d,conversation:s,messages:f,sendMessage:h,isOwnMessage:y}},Y=({onSubmit:r,placeholder:t="Type your message...",parentMessage:a,onCancelReply:s,initialValue:u="",submitLabel:f="Send"})=>{const[c,d]=x.useState(u),[n,l]=x.useState(!1),g=h=>N(void 0,null,function*(){if(h.preventDefault(),!(!c.trim()||n)){l(!0);try{yield r(c.trim()),d(""),s==null||s()}catch(y){console.error("Error submitting message:",y)}finally{l(!1)}}}),m=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),g(h))};return e.jsx(P,{className:"shadow-sm",children:e.jsxs(k,{className:"p-4",children:[a&&e.jsxs("div",{className:"mb-3 p-3 bg-muted rounded-lg text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"font-medium text-muted-foreground",children:["Replying to ",a.user_display_name]}),e.jsx(v,{variant:"ghost",size:"sm",onClick:s,className:"h-6 w-6 p-0",children:e.jsx(B,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-muted-foreground line-clamp-2",children:a.content})]}),e.jsxs("form",{onSubmit:g,className:"space-y-3",children:[e.jsx(J,{value:c,onChange:h=>d(h.target.value),onKeyDown:m,placeholder:t,className:"min-h-[80px] resize-none",disabled:n}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Press Enter to send, Shift+Enter for new line"}),e.jsxs(v,{type:"submit",disabled:!c.trim()||n,className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),f]})]})]})]})})},Me=()=>{var d,n,l,g;const{conversationId:r}=G(),t=K();console.log("Chat component: conversationId =",r),console.log("Chat component: location =",window.location.href);const{loading:a,conversation:s,messages:u,sendMessage:f,isOwnMessage:c}=W(r);return r?e.jsx(M,{children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>t(-1),children:[e.jsx(V,{className:"h-4 w-4 mr-1"})," Back"]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Chat ID: ",r]})]}),e.jsxs(P,{children:[e.jsx(O,{className:"flex flex-row items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(I,{children:[e.jsx(H,{src:(d=s==null?void 0:s.other_user)==null?void 0:d.avatar_url}),e.jsx(X,{children:((l=(n=s==null?void 0:s.other_user)==null?void 0:n.display_name)==null?void 0:l.charAt(0))||"U"})]}),e.jsxs("div",{children:[e.jsx(R,{className:"text-lg",children:((g=s==null?void 0:s.other_user)==null?void 0:g.display_name)||"Loading..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s!=null&&s.created_at?`Started ${D(new Date(s.created_at),"PPp")}`:"Loading conversation..."})]})]})}),e.jsxs(k,{children:[e.jsx("div",{className:"h-[50vh] overflow-y-auto space-y-3 p-2 bg-muted/30 rounded-md",children:a?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):s?u.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-500",children:"No messages yet. Start the conversation!"})}):u.map(m=>e.jsx("div",{className:`flex ${c(m.sender_id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg px-3 py-2 text-sm ${c(m.sender_id)?"bg-primary text-primary-foreground":"bg-card border"}`,children:[e.jsx("div",{className:"whitespace-pre-wrap",children:m.message}),e.jsx("div",{className:`mt-1 text-[10px] ${c(m.sender_id)?"text-primary-foreground/70":"text-muted-foreground"}`,children:D(new Date(m.created_at),"PPp")})]})},m.id)):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"Conversation not found"}),e.jsx(v,{onClick:()=>t("/messages"),children:"Go to Messages"})]})})}),s&&(s.status==="active"||s.status==="pending")?e.jsx("div",{className:"mt-4",children:e.jsx(Y,{onSubmit:f,placeholder:"Send a message..."})}):s?e.jsx("div",{className:"mt-4 text-sm text-muted-foreground",children:s.status==="pending"?e.jsxs("div",{children:["This conversation is pending. Go to Messages to accept or decline.",e.jsx(v,{variant:"outline",size:"sm",className:"ml-2",onClick:()=>t("/messages"),children:"Open Messages"})]}):e.jsx("div",{children:"This conversation is closed."})}):null]})]})]})}):e.jsx(M,{children:e.jsx("div",{className:"max-w-4xl mx-auto space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Invalid Chat"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No conversation ID provided"}),e.jsx(v,{onClick:()=>t("/messages"),children:"Go to Messages"})]})})})};export{Me as default};
