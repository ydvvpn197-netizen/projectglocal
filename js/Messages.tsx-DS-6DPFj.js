var M=Object.defineProperty,$=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var C=(t,a,r)=>a in t?M(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,A=(t,a)=>{for(var r in a||(a={}))L.call(a,r)&&C(t,r,a[r]);if(w)for(var r of w(a))O.call(a,r)&&C(t,r,a[r]);return t},R=(t,a)=>$(t,z(a));var j=(t,a,r)=>new Promise((p,m)=>{var v=c=>{try{u(r.next(c))}catch(x){m(x)}},f=c=>{try{u(r.throw(c))}catch(x){m(x)}},u=c=>c.done?p(c.value):Promise.resolve(c.value).then(v,f);u((r=r.apply(t,a)).next())});import{n as V,ax as G,r as h,j as e,x as S}from"./chunk-COTa-BBv.js";import{ResponsiveLayout as H}from"./ResponsiveLayout.tsx-wqK2pe-W.js";import{a as J,u as K,C as _,b as g,B as b}from"./main-BEfTDqLJ.js";import{T as Q,a as W,b as E,c as T}from"./chunk-Cvi3W8GP.js";import{A as k,a as P,b as B}from"./chunk-lml2Yya-.js";import{B as X}from"./chunk-uGCRAzUf.js";import{s as N}from"./chunk-CasIWBEQ.js";import{a as D}from"./chunk-DJzzOJWe.js";import"./chunk-DvlvDbdf.js";import"./chunk-BlluHz2J.js";import"./chunk-BA32w1ww.js";import"./chunk-C4jjqBrH.js";const me=()=>{const{user:t}=J(),{toast:a}=K(),r=V(),[p]=G(),[m,v]=h.useState(!0),[f,u]=h.useState([]),[c,x]=h.useState([]);h.useEffect(()=>{t&&y()},[t==null?void 0:t.id]),h.useEffect(()=>{const s=p.get("conversation");s&&t&&r(`/chat/${s}`)},[p,r,t]);const y=()=>j(null,null,function*(){if(t){v(!0);try{const{data:s,error:n}=yield N.from("chat_conversations").select("*").or(`client_id.eq.${t.id},artist_id.eq.${t.id}`).order("updated_at",{ascending:!1});if(n)throw n;const d=s||[],o=d.map(i=>i.client_id===t.id?i.artist_id:i.client_id),{data:l}=yield N.from("profiles").select("user_id, display_name, avatar_url").in("user_id",o),F=new Map((l||[]).map(i=>[i.user_id,i])),q=d.map(i=>R(A({},i),{other_user:F.get(i.client_id===t.id?i.artist_id:i.client_id)}));u(q.filter(i=>i.status==="active")),x(q.filter(i=>i.status==="pending"&&i.client_id!==t.id))}catch(s){console.error("Error loading conversations:",s),a({title:"Error",description:s.message||"Failed to load messages",variant:"destructive"})}finally{v(!1)}}}),I=s=>j(null,null,function*(){const{error:n}=yield N.from("chat_conversations").update({status:"active",updated_at:new Date().toISOString()}).eq("id",s);n?a({title:"Error",description:"Failed to accept request",variant:"destructive"}):(y(),a({title:"Request accepted"}))}),U=s=>j(null,null,function*(){const{error:n}=yield N.from("chat_conversations").update({status:"closed",updated_at:new Date().toISOString()}).eq("id",s);n?a({title:"Error",description:"Failed to decline request",variant:"destructive"}):(y(),a({title:"Request declined"}))});return e.jsx(H,{children:e.jsxs("div",{className:"container max-w-4xl mx-auto p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Chat with your connections. Requests must be accepted before chatting."})]}),e.jsxs(Q,{defaultValue:"active",children:[e.jsxs(W,{children:[e.jsx(E,{value:"active",children:"Active"}),e.jsx(E,{value:"requests",children:"Requests"})]}),e.jsx(T,{value:"active",className:"mt-4",children:m?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):f.length===0?e.jsx(_,{children:e.jsxs(g,{className:"text-center py-12 text-muted-foreground",children:[e.jsx(S,{className:"h-10 w-10 mx-auto mb-2"}),"No active conversations"]})}):e.jsx("div",{className:"space-y-3",children:f.map(s=>{var n,d,o,l;return e.jsx(_,{className:"cursor-pointer hover:shadow-md",onClick:()=>r(`/chat/${s.id}`),children:e.jsxs(g,{className:"p-4 flex items-center gap-3",children:[e.jsxs(k,{children:[e.jsx(P,{src:(n=s.other_user)==null?void 0:n.avatar_url}),e.jsx(B,{children:((o=(d=s.other_user)==null?void 0:d.display_name)==null?void 0:o.charAt(0))||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:((l=s.other_user)==null?void 0:l.display_name)||"User"}),s.booking_id&&e.jsx(X,{variant:"secondary",children:"Booking"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Started ",D(new Date(s.created_at),"PPp")]})]}),e.jsx(b,{variant:"outline",size:"sm",children:"Open"})]})},s.id)})})}),e.jsx(T,{value:"requests",className:"mt-4",children:m?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):c.length===0?e.jsx(_,{children:e.jsxs(g,{className:"text-center py-12 text-muted-foreground",children:[e.jsx(S,{className:"h-10 w-10 mx-auto mb-2"}),"No pending requests"]})}):e.jsx("div",{className:"space-y-3",children:c.map(s=>{var n,d,o,l;return e.jsx(_,{children:e.jsxs(g,{className:"p-4 flex items-center gap-3",children:[e.jsxs(k,{children:[e.jsx(P,{src:(n=s.other_user)==null?void 0:n.avatar_url}),e.jsx(B,{children:((o=(d=s.other_user)==null?void 0:d.display_name)==null?void 0:o.charAt(0))||"U"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:((l=s.other_user)==null?void 0:l.display_name)||"User"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Requested ",D(new Date(s.created_at),"PPp")]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{size:"sm",onClick:()=>I(s.id),children:"Accept"}),e.jsx(b,{size:"sm",variant:"outline",onClick:()=>U(s.id),children:"Decline"})]})]})},s.id)})})})]})]})})};export{me as default};
