var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,o=(e,s,t)=>new Promise((r,i)=>{var a=e=>{try{o(t.next(e))}catch(s){i(s)}},n=e=>{try{o(t.throw(e))}catch(s){i(s)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,n);o((t=t.apply(e,s)).next())});import{u as l,d,r as c,s as m,j as u,B as p,X as j,v as h,b as x}from"./index-BG6xRDTV.js";import{n as v}from"./useNotifications-B1ZtpJoQ.js";import{R as f}from"./ResponsiveLayout-Cy8fRDGj.js";import{C as g,d as y,a as b,b as _}from"./card-CbL4dXrv.js";import{A as N,a as w,b as S}from"./sheet-D3ubJQDf.js";import{T as O}from"./textarea-2ipISJ4Z.js";import{S as P}from"./send-CdaaQyaU.js";import{A as M}from"./arrow-left-BuOR-LC4.js";import{f as C}from"./index-DxejKcbp.js";import"./index-B4GyU7fY.js";import"./Combination-Ca6tC3WL.js";import"./tabs-DsAJelf8.js";import"./check-CF8HR3W6.js";import"./input-CK5tWTqm.js";import"./separator-HAFz-71w.js";import"./NotificationBell-DnloidrO.js";import"./badge-B2QlhVT_.js";import"./scroll-area-HbJeSRic.js";import"./index-jVOyRz7F.js";import"./bell-9bXVKGDo.js";import"./settings-C5hGa_4W.js";import"./user-innQK5gL.js";import"./NotificationButton-BhOs_94_.js";import"./search-B4Ny2Otc.js";import"./map-pin-Cmdgk16n.js";import"./index-Dy3819KX.js";import"./users-C0r8Z-ie.js";import"./zap-3-X3ymuv.js";import"./message-square-B4qpNpo_.js";import"./alert-yPy2QlxQ.js";import"./log-out-CsYOYMhW.js";const E=e=>{const{user:u}=l(),{toast:p}=d(),[j,h]=c.useState(null),[x,f]=c.useState([]),[g,y]=c.useState(!0),b=c.useRef(null);c.useEffect(()=>{if(!e||!u)return;y(!0),_(),N();const s=m.channel(`chat_messages_${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`conversation_id=eq.${e}`},e=>{f(s=>[...s,e.new])}).subscribe();return b.current=s,()=>{b.current&&m.removeChannel(b.current)}},[e,null==u?void 0:u.id]);const _=()=>o(void 0,null,function*(){try{const{data:o,error:l}=yield m.from("chat_conversations").select("*").eq("id",e).single();if(l)throw l;const d=o.client_id===(null==u?void 0:u.id)?o.artist_id:o.client_id,{data:c}=yield m.from("profiles").select("user_id, display_name, avatar_url").eq("user_id",d).single();h(((e,r)=>s(e,t(r)))(((e,s)=>{for(var t in s||(s={}))i.call(s,t)&&n(e,t,s[t]);if(r)for(var t of r(s))a.call(s,t)&&n(e,t,s[t]);return e})({},o),{other_user:c||void 0}))}catch(o){p({title:"Error",description:o.message||"Failed to load conversation",variant:"destructive"})}finally{y(!1)}}),N=()=>o(void 0,null,function*(){try{const{data:s,error:t}=yield m.from("chat_messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(t)throw t;f(s||[])}catch(s){p({title:"Error",description:s.message||"Failed to load messages",variant:"destructive"})}}),w=c.useMemo(()=>e=>e===(null==u?void 0:u.id),[null==u?void 0:u.id]);return{loading:g,conversation:j,messages:x,sendMessage:s=>o(void 0,null,function*(){if(!u||!e)return;const{error:t}=yield m.from("chat_messages").insert({conversation_id:e,sender_id:u.id,message:s,message_type:"text"});if(t)throw t;if("pending"===(null==j?void 0:j.status)){const s=u.id===(null==j?void 0:j.client_id)?null==j?void 0:j.artist_id:null==j?void 0:j.client_id;if(s)try{yield v.createMessageRequestNotification(u.id,s,e)}catch(r){}}}),isOwnMessage:w}},R=({onSubmit:e,placeholder:s="Type your message...",parentMessage:t,onCancelReply:r,initialValue:i="",submitLabel:a="Send"})=>{const[n,l]=c.useState(i),[d,m]=c.useState(!1),h=s=>o(void 0,null,function*(){if(s.preventDefault(),n.trim()&&!d){m(!0);try{yield e(n.trim()),l(""),null==r||r()}catch(t){}finally{m(!1)}}});return u.jsx(g,{className:"shadow-sm",children:u.jsxs(y,{className:"p-4",children:[t&&u.jsxs("div",{className:"mb-3 p-3 bg-muted rounded-lg text-sm",children:[u.jsxs("div",{className:"flex items-center justify-between mb-1",children:[u.jsxs("span",{className:"font-medium text-muted-foreground",children:["Replying to ",t.user_display_name]}),u.jsx(p,{variant:"ghost",size:"sm",onClick:r,className:"h-6 w-6 p-0",children:u.jsx(j,{className:"h-4 w-4"})})]}),u.jsx("p",{className:"text-muted-foreground line-clamp-2",children:t.content})]}),u.jsxs("form",{onSubmit:h,className:"space-y-3",children:[u.jsx(O,{value:n,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),h(e))},placeholder:s,className:"min-h-[80px] resize-none",disabled:d}),u.jsxs("div",{className:"flex justify-between items-center",children:[u.jsx("span",{className:"text-xs text-muted-foreground",children:"Press Enter to send, Shift+Enter for new line"}),u.jsxs(p,{type:"submit",disabled:!n.trim()||d,className:"flex items-center gap-2",children:[u.jsx(P,{className:"h-4 w-4"}),a]})]})]})]})})},D=()=>{var e,s,t,r;const{conversationId:i}=h(),a=x(),{loading:n,conversation:o,messages:l,sendMessage:d,isOwnMessage:c}=E(i);return u.jsx(f,{children:u.jsxs("div",{className:"max-w-4xl mx-auto space-y-4",children:[u.jsx("div",{className:"flex items-center gap-3",children:u.jsxs(p,{variant:"outline",size:"sm",onClick:()=>a(-1),children:[u.jsx(M,{className:"h-4 w-4 mr-1"})," Back"]})}),u.jsxs(g,{children:[u.jsx(b,{className:"flex flex-row items-center justify-between",children:u.jsxs("div",{className:"flex items-center gap-3",children:[u.jsxs(N,{children:[u.jsx(w,{src:null==(e=null==o?void 0:o.other_user)?void 0:e.avatar_url}),u.jsx(S,{children:(null==(t=null==(s=null==o?void 0:o.other_user)?void 0:s.display_name)?void 0:t.charAt(0))||"U"})]}),u.jsxs("div",{children:[u.jsx(_,{className:"text-lg",children:(null==(r=null==o?void 0:o.other_user)?void 0:r.display_name)||"Conversation"}),u.jsxs("p",{className:"text-sm text-muted-foreground",children:["Started ",(null==o?void 0:o.created_at)?C(new Date(o.created_at),"PPp"):""]})]})]})}),u.jsxs(y,{children:[u.jsx("div",{className:"h-[50vh] overflow-y-auto space-y-3 p-2 bg-muted/30 rounded-md",children:n?u.jsx("div",{className:"flex items-center justify-center h-full",children:u.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):l.map(e=>u.jsx("div",{className:"flex "+(c(e.sender_id)?"justify-end":"justify-start"),children:u.jsxs("div",{className:"max-w-[70%] rounded-lg px-3 py-2 text-sm "+(c(e.sender_id)?"bg-primary text-primary-foreground":"bg-card border"),children:[u.jsx("div",{className:"whitespace-pre-wrap",children:e.message}),u.jsx("div",{className:"mt-1 text-[10px] "+(c(e.sender_id)?"text-primary-foreground/70":"text-muted-foreground"),children:C(new Date(e.created_at),"PPp")})]})},e.id))}),"active"===(null==o?void 0:o.status)||"pending"===(null==o?void 0:o.status)?u.jsx("div",{className:"mt-4",children:u.jsx(R,{onSubmit:d,placeholder:"Send a message..."})}):u.jsx("div",{className:"mt-4 text-sm text-muted-foreground",children:"pending"===(null==o?void 0:o.status)?u.jsxs("div",{children:["This conversation is pending. Go to Messages to accept or decline.",u.jsx(p,{variant:"outline",size:"sm",className:"ml-2",onClick:()=>a("/messages"),children:"Open Messages"})]}):u.jsx("div",{children:"This conversation is closed."})})]})]})]})})};export{D as default};
